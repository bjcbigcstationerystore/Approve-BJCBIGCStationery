<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>APPROVAL STATIONERY STORE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    @keyframes slideIn { from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)} }
    .animate-slide-in{ animation: slideIn .3s ease-out; }
    .filter-btn{ transition:all .2s ease; }
    .filter-btn:hover{ transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.15) }
    .filter-btn.active{ background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:#fff; transform:translateY(-2px); box-shadow:0 4px 12px rgba(59,130,246,.3) }
    .table-row{ transition:all .2s ease; }
    .table-row:hover{ background:#f8fafc; transform:scale(1.005); }
    .modal{ display:none; position:fixed; inset:0; width:100%; height:100%; background:rgba(0,0,0,.5); z-index:1000; animation:fadeIn .2s ease; }
    .modal.active{ display:flex; align-items:center; justify-content:center; }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    .modal-content{ animation:slideIn .3s ease-out; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

  <!-- Login Page -->
  <div id="login-page" class="min-h-screen flex items-center justify-center px-4">
    <div class="max-w-md w-full space-y-8">
      <div class="text-center">
        <div class="mb-8">
          <img src="https://i.postimg.cc/B6wpk3yh/cropped-Logo-BJC-Big-C-2021-2048x606.png" alt="BJC Big C Logo" class="mx-auto h-20 w-auto" onerror="this.src=''; this.alt='Logo failed to load'; this.style.display='none';">
        </div>
        <h1 class="text-4xl font-bold text-gray-800 mb-4">APPROVAL STATIONERY STORE</h1>
        <div class="w-24 h-1 bg-gradient-to-r from-blue-500 to-indigo-600 mx-auto rounded-full mb-6"></div>
        <div class="mb-8">
          <p class="text-2xl text-gray-700 mb-2">üè¢‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>
          <p class="text-lg text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-xl p-8 animate-slide-in">
        <form onsubmit="handleLogin(event)" class="space-y-6">
          <div>
            <label for="employee-id" class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
            <input id="employee-id" name="employee-id" type="text" required
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
                   placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" autocomplete="username">
          </div>
          <div>
            <button type="submit"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200">
              üöÄ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
            </button>
          </div>
        </form>
        <div class="mt-6 p-4 bg-blue-50 rounded-lg">
          <p class="text-sm text-blue-700 text-center">
            üí° <strong>Note:</strong> ‡∏ï‡πâ‡∏≠‡∏á Publish ‡∏ä‡∏µ‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ (File ‚Üí <em>Publish to the web</em>) ‡∏Å‡πà‡∏≠‡∏ô
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard-page" class="container mx-auto px-4 py-8 max-w-7xl" style="display:none;">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">APPROVAL STATIONERY STORE</h1>
      <div class="w-24 h-1 bg-gradient-to-r from-blue-500 to-indigo-600 mx-auto rounded-full"></div>
    </div>

    <!-- Approver Info -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 animate-slide-in">
      <div class="flex items-center">
        <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-4xl mr-6">üë§</div>
        <div class="flex-1">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
              <p class="text-gray-500 text-sm mb-1">Name</p>
              <p class="text-xl font-bold text-gray-800" id="user-name">-</p>
            </div>
            <div>
              <p class="text-gray-500 text-sm mb-1">Email</p>
              <p class="text-lg font-semibold text-blue-600" id="user-email">-</p>
            </div>
            <div>
              <p class="text-gray-500 text-sm mb-1">Cost Center</p>
              <p class="text-lg font-semibold text-gray-700" id="user-cost-center">-</p>
            </div>
            <div>
              <p class="text-gray-500 text-sm mb-1">Division</p>
              <p class="text-lg font-semibold text-gray-700" id="user-division">-</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Table + Filters -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</h3>
        </div>

        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
          <div class="flex flex-wrap gap-2">
            <button onclick="filterByStatus('all')" class="filter-btn active px-4 py-2 rounded-lg font-medium text-sm bg-gray-100 text-gray-700" data-status="all">
              ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="total-count">0</span>)
            </button>
            <button onclick="filterByStatus('approved')" class="filter-btn px-4 py-2 rounded-lg font-medium text-sm bg-gray-100 text-gray-700" data-status="approved">
              ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (<span id="approved-count">0</span>)
            </button>
            <button onclick="filterByStatus('pending')" class="filter-btn px-4 py-2 rounded-lg font-medium text-sm bg-gray-100 text-gray-700" data-status="pending">
              ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (<span id="pending-count">0</span>)
            </button>
            <button onclick="filterByStatus('revise')" class="filter-btn px-4 py-2 rounded-lg font-medium text-sm bg-gray-100 text-gray-700" data-status="revise">
              ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (<span id="revise-count">0</span>)
            </button>
            <button onclick="filterByStatus('rejected')" class="filter-btn px-4 py-2 rounded-lg font-medium text-sm bg-gray-100 text-gray-700" data-status="rejected">
              ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (<span id="rejected-count">0</span>)
            </button>
          </div>

          <!-- ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
          <div class="flex items-center gap-2 ml-auto">
            <label for="date-filter" class="text-sm text-gray-600">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
            <select id="date-filter" onchange="filterByDate()"
                    class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="all" selected>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
              <option value="week">7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
              <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
              <option value="latest">3 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
            </select>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Request Number</th>
              <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</th>
              <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</th>
              <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ä‡∏¥‡πâ‡∏ô)</th>
              <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
              <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th class="px-6 py-4 text-center text-sm font-semibold text-gray-700">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="detail-modal" class="modal">
    <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90%] overflow-y-auto">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-2xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</h3>
          <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
        </div>
      </div>
      <div class="p-6" id="modal-content"></div>
      <div class="p-6 border-t border-gray-200 bg-gray-50 flex gap-3 justify-end">
        <button onclick="closeModal()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium transition">‡∏õ‡∏¥‡∏î</button>
        <!-- ‡πÇ‡∏´‡∏°‡∏î GitHub: ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ä‡∏µ‡∏ï) -->
        <button onclick="alert('‡πÇ‡∏´‡∏°‡∏î GitHub: ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 font-medium transition">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
        <button onclick="alert('‡πÇ‡∏´‡∏°‡∏î GitHub: ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô')" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 font-medium transition">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
        <button onclick="alert('‡πÇ‡∏´‡∏°‡∏î GitHub: ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô')" class="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-medium transition">üîÑ ‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </div>
    </div>
  </div>

  <script>
    /************ CONFIG ************/
    const SPREADSHEET_ID   = '15Nzap1xe_qkcBoVskRTMG7o7Gb_zE8nTRm8rY3VeMmg';
    const MASTER_SHEET     = 'Master';
    const ADMIN_BU_SHEET   = 'Admin BU';
    const BU_APPROVE_SHEET = 'BU Approve';
    const RESPONSE_SHEET   = 'Response';

    /************ STATE ************/
    let requestsData = [];
    let currentRequestId = null;
    let currentFilter = 'all';
    let currentDateFilter = 'all';
    let currentUser = null;

    /************ GVIZ FETCH ************/
    async function gvizQuery(sheetName, tq) {
      const base = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SPREADSHEET_ID)}/gviz/tq`;
      const url = `${base}?sheet=${encodeURIComponent(sheetName)}&tqx=out:json&tq=${encodeURIComponent(tq)}`;
      const res = await fetch(url, { method:'GET' });
      const text = await res.text();
      const start = text.indexOf('{');
      const end = text.lastIndexOf('}');
      if (start === -1 || end === -1) throw new Error('GViz response malformed (‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Publish to the web)');
      const json = JSON.parse(text.substring(start, end + 1));
      if (!json.table) return { cols:[], rows:[] };
      return json.table;
    }

    function cellVal(c) {
      if (!c) return '';
      if ('v' in c && c.v != null) {
        if (c.f) return c.f; // formatted string
        return c.v;
      }
      return '';
    }

    function toISO(dateStr) {
      if (!dateStr) return '';
      const slash = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (slash) {
        const d = String(slash[1]).padStart(2,'0');
        const m = String(slash[2]).padStart(2,'0');
        const y = slash[3];
        return `${y}-${m}-${d}`;
      }
      const iso = dateStr.match(/^\d{4}-\d{2}-\d{2}$/);
      if (iso) return dateStr;
      const d = new Date(dateStr);
      if (!isNaN(d.getTime())) {
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
      }
      return String(dateStr);
    }

    /************ DATA LOADERS ************/
    async function loadUserByEmpId(empId) {
      const safeEmp = empId.replace(/'/g, "\\'");
      // C=Role, D=Cost, E=Division, F=EmpID, G=Name, H=Email
      const tq = `select C,D,E,F,G,H where F='${safeEmp}'`;
      const table = await gvizQuery(MASTER_SHEET, tq);
      const rows = table.rows || [];
      if (!rows.length) return null;

      const r = rows[0].c;
      const role       = String(cellVal(r[0]) || '').trim();
      const costCenter = String(cellVal(r[1]) || '').trim();
      const division   = String(cellVal(r[2]) || '').trim();
      const emp        = String(cellVal(r[3]) || '').trim();
      const name       = String(cellVal(r[4]) || '').trim();
      const email      = String(cellVal(r[5]) || '').trim();

      return { empId: emp, role, costCenter, division, name, email };
    }

    async function loadRequestsForRole(role) {
      const sheet = (role === 'BU Admin') ? ADMIN_BU_SHEET
                  : (role === 'BU/BP Head') ? BU_APPROVE_SHEET
                  : BU_APPROVE_SHEET;

      // A=req no, B=date, G=requester, J=items, K=amount, L=status(optional)
      const tq = `select A,B,G,J,K,L`;
      const table = await gvizQuery(sheet, tq);
      const rows = table.rows || [];
      const colCount = (table.cols || []).length;

      const out = rows.map(row => {
        const c = row.c || [];
        const id      = String(cellVal(c[0]) || '').trim();
        const dateRaw = cellVal(c[1]);
        const requester = String(cellVal(c[2]) || '').trim();
        const items   = String(cellVal(c[3]) || '').trim();
        const amountV = cellVal(c[4]);
        const statusV = (colCount >= 6) ? String((cellVal(c[5]) || '')).trim().toLowerCase() : 'pending';

        const amount = (typeof amountV === 'number') ? amountV : Number(amountV);
        const dateISO = toISO(dateRaw);

        return {
          id,
          requester,
          date: dateISO || String(dateRaw || ''),
          items,
          amount: Number.isFinite(amount) ? amount : (amountV || ''),
          status: statusV || 'pending'
        };
      }).filter(o => o.id);

      return out;
    }

    // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï Response ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Request number (A) ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
    async function loadDetailByRequestNumber(reqNo) {
      const safe = String(reqNo || '').replace(/'/g, "\\'");
      const tq = `select * where A='${safe}'`;
      const table = await gvizQuery(RESPONSE_SHEET, tq);
      const rows = table.rows || [];
      if (!rows.length) return null;

      const c = rows[0].c || [];
      // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏•‡∏±‡∏Å
      const reqNumber   = String(cellVal(c[0]) || '').trim(); // A
      const dateRaw     = cellVal(c[1]);                      // B
      const requester   = String(cellVal(c[6]) || '').trim(); // G
      const itemCount   = cellVal(c[9]);                      // J ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å
      const amountV     = cellVal(c[10]);                     // K ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°
      const amount      = (typeof amountV === 'number') ? amountV : Number(amountV);
      const dateISO     = toISO(dateRaw);

      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå L(11) M(12) N(13) ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏•‡πà‡πÑ‡∏õ‡∏ó‡∏µ‡∏•‡∏∞ 3
      const items = [];
      for (let i = 11; i < c.length; i += 3) {
        const name = String(cellVal(c[i]) || '').trim();       // L, O, R, ...
        const qtyV = cellVal(c[i + 1]);                        // M, P, S, ...
        const priceV = cellVal(c[i + 2]);                      // N, Q, T, ...
        if (!name && !qtyV && !priceV) continue;               // ‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        const qty   = (typeof qtyV === 'number') ? qtyV : Number(qtyV);
        const price = (typeof priceV === 'number') ? priceV : Number(priceV);
        items.push({
          name: name || '-',
          qty: Number.isFinite(qty) ? qty : (qtyV || ''),
          price: Number.isFinite(price) ? price : (priceV || '')
        });
      }

      return {
        reqNumber,
        requester,
        date: dateISO || String(dateRaw || ''),
        itemCount: Number.isFinite(Number(itemCount)) ? Number(itemCount) : itemCount,
        amount: Number.isFinite(amount) ? amount : (amountV || ''),
        items
      };
    }

    /************ UI ************/
    function showLoginError(msg) {
      const input = document.getElementById('employee-id');
      input.classList.add('border-red-500');
      input.focus();
      let errorMsg = document.getElementById('error-message');
      if (!errorMsg) {
        errorMsg = document.createElement('p');
        errorMsg.id = 'error-message';
        errorMsg.className = 'text-red-500 text-sm mt-2';
        input.parentNode.appendChild(errorMsg);
      }
      errorMsg.textContent = '‚ùå ' + (msg || '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      setTimeout(() => {
        input.classList.remove('border-red-500');
        if (errorMsg) errorMsg.remove();
      }, 3000);
    }

    async function handleLogin(event) {
      event.preventDefault();
      const employeeId = document.getElementById('employee-id').value.trim().toUpperCase();
      const btn = event.submitter;
      if (btn) { btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...'; }

      try {
        const user = await loadUserByEmpId(employeeId);
        if (!user || user.empId !== employeeId) {
          if (btn) { btn.disabled = false; btn.textContent = 'üöÄ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠'; }
          return showLoginError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Master');
        }

        currentUser = user;
        document.getElementById('user-name').textContent = currentUser.name || '';
        document.getElementById('user-email').textContent = currentUser.email || '';
        document.getElementById('user-cost-center').textContent = currentUser.costCenter || '';
        document.getElementById('user-division').textContent = currentUser.division || '';

        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
        requestsData = await loadRequestsForRole(currentUser.role);

        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('dashboard-page').style.display = 'block';

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        updateCounts();
        renderFilteredData();
      } catch (err) {
        console.error(err);
        showLoginError('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Publish ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï/‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)');
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = 'üöÄ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠'; }
      }
    }

    function logout() {
      currentUser = null;
      requestsData = [];
      document.getElementById('dashboard-page').style.display = 'none';
      document.getElementById('login-page').style.display = 'block';
      document.getElementById('employee-id').value = '';
    }

    function getStatusBadge(status) {
      const s = (status || '').toLowerCase();
      const badges = {
        'approved': '<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>',
        'pending': '<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-medium">‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>',
        'rejected': '<span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-medium">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</span>',
        'revise': '<span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium">üîÑ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>'
      };
      return badges[s] || `<span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm font-medium">${status || 'pending'}</span>`;
    }

    function renderTable(data = requestsData) {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';
      data.forEach(request => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 table-row cursor-pointer';
        row.onclick = () => showDetail(request.id);
        row.innerHTML = `
          <td class="px-6 py-4 text-sm font-medium text-blue-600">${request.id}</td>
          <td class="px-6 py-4 text-sm text-gray-800">${request.requester}</td>
          <td class="px-6 py-4 text-sm text-gray-600">${request.date}</td>
          <td class="px-6 py-4 text-sm text-gray-700">${request.items}</td>
          <td class="px-6 py-4 text-sm font-semibold text-gray-800">
            ${Number.isFinite(request.amount) ? request.amount.toLocaleString('th-TH') : request.amount} ‡∏ö‡∏≤‡∏ó
          </td>
          <td class="px-6 py-4 text-sm">${getStatusBadge(request.status)}</td>
          <td class="px-6 py-4 text-center">
            <button onclick="event.stopPropagation(); showDetail('${request.id}')"
                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm font-medium transition">
              ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï Response ‡∏ï‡∏≤‡∏° Request Number
    async function showDetail(requestId) {
      currentRequestId = requestId;
      const modalContent = document.getElementById('modal-content');
      modalContent.innerHTML = `<div class="p-6 text-center text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≤‡∏Å Response...</div>`;
      document.getElementById('detail-modal').classList.add('active');

      try {
        const detail = await loadDetailByRequestNumber(requestId);
        if (!detail) {
          modalContent.innerHTML = `<div class="p-6 text-center text-red-600">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï Response ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${requestId}</div>`;
          return;
        }

        const rows = detail.items.map((it, idx) => `
          <tr class="border-b border-gray-100">
            <td class="px-4 py-3 text-sm text-gray-500 text-center">${idx + 1}</td>
            <td class="px-4 py-3 text-sm text-gray-800">${it.name}</td>
            <td class="px-4 py-3 text-sm text-gray-700 text-center">${it.qty}</td>
            <td class="px-4 py-3 text-sm text-gray-700 text-right">
              ${Number.isFinite(it.price) ? it.price.toLocaleString('th-TH') : it.price}
            </td>
          </tr>
        `).join('') || `
          <tr><td colspan="4" class="px-4 py-3 text-center text-sm text-gray-500">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -</td></tr>
        `;

        modalContent.innerHTML = `
          <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-4">
                <div>
                  <p class="text-sm text-gray-500 mb-1">Request Number</p>
                  <p class="text-lg font-semibold text-gray-800">${detail.reqNumber}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 mb-1">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</p>
                  <p class="text-base font-medium text-gray-800">${detail.requester}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</p>
                  <p class="text-base font-medium text-gray-800">${detail.date}</p>
                </div>
              </div>
              <div class="space-y-4">
                <div class="bg-blue-50 rounded-lg p-4">
                  <p class="text-sm text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</p>
                  <p class="text-xl font-bold text-blue-600">
                    ${Number.isFinite(detail.itemCount) ? detail.itemCount : (detail.itemCount || '-')} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                  </p>
                </div>
                <div class="bg-blue-50 rounded-lg p-4">
                  <p class="text-sm text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</p>
                  <p class="text-2xl font-bold text-blue-600">
                    ${Number.isFinite(detail.amount) ? detail.amount.toLocaleString('th-TH') : detail.amount} ‡∏ö‡∏≤‡∏ó
                  </p>
                </div>
              </div>
            </div>

            <div>
              <h4 class="text-lg font-semibold text-gray-800 mb-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h4>
              <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="w-full">
                  <thead class="bg-gray-200">
                    <tr>
                      <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700" style="width:80px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                      <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700" style="width:120px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                      <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700" style="width:140px;">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${rows}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
      } catch (e) {
        console.error(e);
        modalContent.innerHTML = `<div class="p-6 text-center text-red-600">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>`;
      }
    }

    function closeModal() {
      document.getElementById('detail-modal').classList.remove('active');
      currentRequestId = null;
    }

    function updateCounts() {
      document.getElementById('total-count').textContent    = requestsData.length;
      document.getElementById('approved-count').textContent = requestsData.filter(r => (r.status||'').toLowerCase()==='approved').length;
      document.getElementById('pending-count').textContent  = requestsData.filter(r => (r.status||'').toLowerCase()==='pending').length;
      document.getElementById('rejected-count').textContent = requestsData.filter(r => (r.status||'').toLowerCase()==='rejected').length;
      document.getElementById('revise-count').textContent   = requestsData.filter(r => (r.status||'').toLowerCase()==='revise').length;
    }

    function filterByStatus(status) {
      currentFilter = status;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      const activeBtn = document.querySelector(`[data-status="${status}"]`);
      if (activeBtn) activeBtn.classList.add('active');
      renderFilteredData();
    }

    function filterByDate() {
      const sel = document.getElementById('date-filter');
      currentDateFilter = sel ? sel.value : 'all';
      renderFilteredData();
    }

    function renderFilteredData() {
      let filtered = requestsData.slice();

      if (currentFilter !== 'all') {
        filtered = filtered.filter(r => (r.status||'').toLowerCase() === currentFilter);
      }

      if (currentDateFilter !== 'all') {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        filtered = filtered.filter(r => {
          const requestDate = new Date(r.date);
          switch (currentDateFilter) {
            case 'today':
              return r.date === todayStr;
            case 'week': {
              const weekAgo = new Date(today.getTime() - 7*24*60*60*1000);
              return requestDate >= weekAgo;
            }
            case 'month':
              return requestDate.getMonth() === today.getMonth() &&
                     requestDate.getFullYear() === today.getFullYear();
            case 'latest': {
              const threeDaysAgo = new Date(today.getTime() - 3*24*60*60*1000);
              return requestDate >= threeDaysAgo;
            }
            default:
              return true;
          }
        });
      }

      filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
      renderTable(filtered);
    }

    // UX: close modal on backdrop/Escape
    document.getElementById('detail-modal').addEventListener('click', (e) => {
      if (e.target.id === 'detail-modal') closeModal();
    });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
  </script>
</body>
</html>

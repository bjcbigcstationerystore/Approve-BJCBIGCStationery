<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>APPROVAL STATIONERY STORE</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { prompt: ['Prompt', 'system-ui', 'sans-serif'] },
          boxShadow: {
            soft: '0 10px 30px rgba(2, 6, 23, .08)'
          }
        }
      }
    }
  </script>

  <style>
    :root {
      --card-w: 720px;
    }
    body {
      font-family: 'Prompt', system-ui, sans-serif;
      background:
        radial-gradient(1200px 600px at 50% -200px, rgba(59,130,246,.15), rgba(59,130,246,0)),
        radial-gradient(800px 600px at 80% 0, rgba(99,102,241,.12), rgba(99,102,241,0)),
        linear-gradient(180deg, #eef2ff 0%, #f8fafc 70%);
      min-height: 100vh;
    }
    .card {
      width: min(var(--card-w), calc(100% - 32px));
      background: white;
      border-radius: 20px;
      box-shadow: var(--tw-shadow, 0 20px 60px rgba(2,6,23,.08));
      padding: 28px;
    }
    .logo {
      width: 340px; max-width: 80vw; height: auto;
      filter: drop-shadow(0 6px 18px rgba(2,6,23,.08));
    }
    .title {
      letter-spacing: .02em;
      text-shadow: 0 2px 0 rgba(255,255,255,.7);
    }
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    }
    .btn-primary:hover {
      filter: brightness(1.02);
      transform: translateY(-1px);
    }
    .note {
      background: #f8fafc;
      border: 1px dashed #e2e8f0;
    }
    .divider {
      margin: 10px auto 0;
      width: 72px; height: 3px; border-radius: 999px;
      background: linear-gradient(90deg,#1d4ed8,#60a5fa);
      opacity: .85;
    }
    .hint-error {
      animation: fadeIn .15s ease-out;
    }
    @keyframes fadeIn { from{opacity:0; transform:translateY(-3px)} to{opacity:1; transform:translateY(0)} }
  </style>
</head>
<body class="text-slate-800">

  <!-- Center container -->
  <div class="min-h-screen flex items-center justify-center px-4">
    <div class="w-full max-w-3xl text-center">

      <!-- Logo -->
      <div class="flex items-center justify-center">
        <img class="logo" alt="BJC Big C" src="https://i.postimg.cc/B6wpk3yh/cropped-Logo-BJC-Big-C-2021-2048x606.png">
      </div>

      <!-- Title -->
      <h1 class="mt-6 text-3xl md:text-4xl font-extrabold title">APPROVAL STATIONERY STORE</h1>
      <div class="divider"></div>

      <!-- Sub -->
      <p class="mt-5 text-slate-600">
        üè¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô<br>
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
      </p>

      <!-- Card -->
      <div class="mt-7 mx-auto card shadow-soft animate-[fadeIn_.25s_ease-out]">
        <form id="verifyForm" class="text-left">
          <label for="empCode" class="block text-sm text-slate-600">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
          <input id="empCode" name="empCode" type="text" inputmode="numeric" autocomplete="off" required
                 class="mt-2 w-full rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 px-4 py-3 outline-none"
                 placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345">

          <button id="submitBtn" type="submit"
            class="mt-4 w-full btn-primary text-white font-medium rounded-xl py-3 transition-all flex items-center justify-center gap-2 active:translate-y-[1px]">
            <span>üöÄ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</span>
            <svg id="loadingIcon" class="hidden animate-spin" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="white" stroke-width="4"></circle>
              <path class="opacity-75" d="M4 12a8 8 0 018-8" stroke="white" stroke-width="4" stroke-linecap="round"></path>
            </svg>
          </button>

          <p id="hint" class="mt-3 text-sm text-rose-600 hidden hint-error">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>

          <div class="note rounded-xl p-4 mt-4 text-sm text-slate-600">
            üí° <b>Note:</b> ‡∏ï‡πâ‡∏≠‡∏á Publish ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ (Anyone with the link ‚Äì Viewer) ‡∏Å‡πà‡∏≠‡∏ô
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    /* ====== CONFIG ====== */
    const SHEET_ID = '15Nzap1xe_qkcBoVskRTMG7o7Gb_zE8nTRm8rY3VeMmg'; // ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤
    const SHEET_NAME = 'User Approve';                                // ‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï
    // ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ping Apps Script ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ
    const APPS_SCRIPT_BASE = 'https://script.google.com/macros/s/AKfycbyUDaiiIRN2_OfWgqiusRYivGmed5Gj0K8_Ry5ogXlNRx854YHvsWizjr83jHQkxcO4Cw/exec';

    // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏à‡∏∞‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    const NEXT_URL = './approval.html'; // ‡∏´‡∏£‡∏∑‡∏≠ './index2.html' ‡∏Ø‡∏•‡∏Ø

    /* ====== UTIL: Read Google Sheets via GViz ====== */
    function buildGVizUrl(code) {
      // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A (emp code) ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏∑‡πà‡∏ô‡∏ï‡∏¥‡∏î‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ
      // where A = '12345' (escape single quotes)
      const safe = String(code).replace(/'/g, "\\'");
      const tq = `select A,B,C,D,E where A='${safe}'`;
      const params = new URLSearchParams({
        tqx: 'out:json',
        sheet: SHEET_NAME,
        tq
      });
      return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?` + params.toString();
    }

    async function fetchGViz(url) {
      const res = await fetch(url, { cache: 'no-store' });
      const text = await res.text();
      // ‡∏ï‡∏±‡∏î wrapper "google.visualization.Query.setResponse(...)"
      const match = text.match(/setResponse\(([\s\S]*)\);?$/);
      if (!match) throw new Error('Bad GViz response');
      const json = JSON.parse(match[1]);
      const cols = json.table.cols.map(c => c.label || c.id || '');
      const rows = json.table.rows.map(r =>
        Object.fromEntries(r.c.map((c,i)=>[cols[i] || `c${i}`, c ? c.v : null]))
      );
      return rows;
    }

    function setLoading(on){
      const btn = document.getElementById('submitBtn');
      const icon = document.getElementById('loadingIcon');
      btn.disabled = on;
      icon.classList.toggle('hidden', !on);
      btn.style.opacity = on ? .85 : 1;
    }
    function showHint(msg){
      const el = document.getElementById('hint');
      el.textContent = msg || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
      el.classList.remove('hidden');
    }
    function hideHint(){
      document.getElementById('hint').classList.add('hidden');
    }

    /* ====== FORM HANDLER ====== */
    document.getElementById('verifyForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      hideHint();

      const code = document.getElementById('empCode').value.trim();
      if (!code) { showHint('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return; }

      setLoading(true);
      try {
        const url = buildGVizUrl(code);
        const rows = await fetchGViz(url);

        if (!rows || rows.length === 0) {
          showHint('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
          setLoading(false);
          return;
        }

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠ (‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏Å‡πâ key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á)
        const rec = rows[0]; // ‡∏û‡∏ö‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å
        sessionStorage.setItem('approver', JSON.stringify({
          empCode: rec.A ?? rec.c0 ?? code,
          colB: rec.B ?? rec.c1 ?? null,
          colC: rec.C ?? rec.c2 ?? null,
          colD: rec.D ?? rec.c3 ?? null,
          colE: rec.E ?? rec.c4 ?? null,
          verifiedAt: new Date().toISOString()
        }));

        // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á ping Apps Script ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (optional)
        // await fetch(APPS_SCRIPT_BASE + '?action=heartbeat&emp=' + encodeURIComponent(code)).catch(()=>{});

        // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        window.location.href = NEXT_URL; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      } catch (err) {
        console.error(err);
        showHint('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
      } finally {
        setLoading(false);
      }
    });

    // UX: ‡∏Å‡∏î Enter ‡πÉ‡∏ô input ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô ‡πÜ
    document.getElementById('empCode').addEventListener('keydown', e=>{
      if (e.key === 'Enter') document.getElementById('submitBtn').focus();
    });
  </script>
</body>
</html>

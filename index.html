<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>APPROVAL STATIONERY STORE</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { prompt: ['Prompt','system-ui','sans-serif'] },
          boxShadow: { soft: '0 10px 30px rgba(2,6,23,.08)' }
        }
      }
    }
  </script>

  <style>
    :root { --card-w: 720px; }
    body{
      font-family:'Prompt',system-ui,sans-serif;
      background:
        radial-gradient(1200px 600px at 50% -200px, rgba(59,130,246,.15), rgba(59,130,246,0)),
        radial-gradient(800px 600px at 80% 0, rgba(99,102,241,.12), rgba(99,102,241,0)),
        linear-gradient(180deg,#eef2ff 0%,#f8fafc 70%);
      min-height:100vh;
      color:#0f172a;
    }
    .card{ width:min(var(--card-w),calc(100% - 32px)); background:#fff; border-radius:20px; box-shadow:var(--tw-shadow,0 20px 60px rgba(2,6,23,.08)); padding:28px; }
    .logo{ width:340px; max-width:80vw; height:auto; filter:drop-shadow(0 6px 18px rgba(2,6,23,.08)); }
    .title{ letter-spacing:.02em; text-shadow:0 2px 0 rgba(255,255,255,.7); }
    .btn-primary{ background:linear-gradient(135deg,#3b82f6,#1d4ed8); }
    .btn-primary:hover{ filter:brightness(1.02); transform:translateY(-1px); }
    .divider{ margin:10px auto 0; width:72px; height:3px; border-radius:999px; background:linear-gradient(90deg,#1d4ed8,#60a5fa); opacity:.85; }
    .hint-error{ animation:fadeIn .15s ease-out; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(-3px)} to{opacity:1; transform:translateY(0)} }

    .title-underline{ width:92px; height:4px; border-radius:999px; background:linear-gradient(90deg,#1d4ed8,#60a5fa); }
    .info-card{ background:#fff; border-radius:18px; padding:18px 20px; box-shadow:var(--tw-shadow,0 20px 60px rgba(2,6,23,.08)); }
    .field-label{ font-size:.78rem; color:#64748b }
    .field-value{ font-weight:600; color:#0f172a }
    .hidden{ display:none !important; }

    /* ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
    .status-chip{
      padding:8px 14px; border-radius:999px; border:1px solid #e2e8f0; background:#fff;
      font-size:14px; color:#0f172a; transition:.15s; box-shadow:0 1px 0 rgba(2,6,23,.02)
    }
    .status-chip:hover{ background:#f8fafc }
    /* default look */
.status-chip.active{
  color:#fff; border-color:transparent;
}

/* All (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ò‡∏µ‡∏°‡∏ü‡πâ‡∏≤) */
.status-chip[data-status="ALL"].active{
  background:linear-gradient(135deg,#3b82f6,#1d4ed8);
}

/* Waiting for approval = ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á */
.status-chip[data-status="WAITING"].active{
  background:linear-gradient(135deg,#f0bc1a,#eab308);
}

/* Submit = ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
.status-chip[data-status="APPROVE"].active{
  background:linear-gradient(135deg,#16a34a,#059669);
}

/* Reject = ‡πÅ‡∏î‡∏á */
.status-chip[data-status="REJECT"].active{
  background:linear-gradient(135deg,#dc2626,#b91c1c);
}
    
    /* ‡πÇ‡∏ó‡∏ô hover ‡πÄ‡∏ö‡∏≤ ‡πÜ ‡∏ï‡∏≠‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà active */
.status-chip:not(.active)[data-status="WAITING"]:hover{ background:#fff7ed }   /* ‡πÅ‡∏ã‡∏°‡∏™‡πâ‡∏°‡∏≠‡πà‡∏≠‡∏ô */
.status-chip:not(.active)[data-status="APPROVE"]:hover { background:#ecfdf5 }   /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô */
.status-chip:not(.active)[data-status="REJECT"]:hover { background:#fef2f2 }   /* ‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô */
.status-chip:not(.active)[data-status="ALL"]:hover     { background:#f0f9ff }   /* ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */


    /* ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÄ‡∏•‡πá‡∏Å) */
    .status-pill{
      padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; display:inline-block;
      background:#e2e8f0; color:#334155;
    }
    .status-pill.waiting{ background:#e0f2fe; color:#075985 }
    .status-pill.approve { background:#dcfce7; color:#166534 }
    .status-pill.reject { background:#fee2e2; color:#991b1b }

    /* ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏ô‡πÇ‡∏°‡∏î‡∏≠‡∏•) */
    .status-badge-big{
      display:inline-block; padding:8px 14px; border-radius:12px; font-weight:800; font-size:18px;
      background:#e0f2fe; color:#075985; border:1px solid rgba(7,89,133,.15);
    }
    .status-badge-big.approve{ background:#dcfce7; color:#166534; border-color:rgba(22,101,52,.15) }
    .status-badge-big.reject{ background:#fee2e2; color:#991b1b; border-color:rgba(153,27,27,.15) }

    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å: ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏£‡∏¥‡∏á 7 ‡∏ä‡πà‡∏≠‡∏á (‡πÑ‡∏°‡πà‡∏°‡∏µ spacer ‡πÅ‡∏•‡πâ‡∏ß) */
:root{
  --col-req:140px;
  --col-name:200px;
  --col-date:120px;
  --col-items:1fr;
  --col-amount:120px;   /* ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô */
  --col-status:150px;   /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
  --col-action:150px;   /* ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î */
}

.grid-head,
.grid-row{
  display:grid;
  grid-template-columns:
    var(--col-req)
    var(--col-name)
    var(--col-date)
    var(--col-items)
    var(--col-amount)
    var(--col-status)
    var(--col-action);
  gap:24px;
  align-items:center;
}

/* ===== ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á ===== */
.grid-head{
  background:#f1f5f9; color:#64748b;
  font-size:13px;
  padding:10px 16px;
}

/* ‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ‡∏î‡∏µ‡∏ü‡∏≠‡∏•‡∏ï‡πå = ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ + ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥ */
.grid-head > div{
  text-align:left;
  white-space:nowrap;
  word-break:keep-all;
}

/* ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏±‡∏ß ‚Äú‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‚Äù ‚Üí ‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤, ‚Äú‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‚Äù ‚Üí ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
.grid-head .text-right{ text-align:right; }
.col-center{
  justify-self: center;
  text-align: center;
}

/* ===== ‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ===== */
.grid-row{
  padding:10px 16px;
  font-size:14px;
  line-height:1.35;
}

/* ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‚Äú‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‚Äù ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏ö‡∏ö 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
.grid-row .truncate{
  white-space:normal;
  overflow:hidden;
  text-overflow:ellipsis;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
}

/* ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‚Äú‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‚Äù ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ */
.col-left{
  justify-self:start !important;
  text-align:left !important;
}

/* ‡∏à‡∏≠‡πÅ‡∏Ñ‡∏ö: ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
@media (max-width: 1200px){
  :root{
    --col-name:200px;
    --col-action:140px;
    --col-amount:128px;
  }
  .grid-head{ font-size:12.5px; }
  .grid-row{ font-size:13.5px; }
}

    /* Modal */
    .modal-overlay { background: rgba(0,0,0,.4); }
    .modal-card   { border-radius: 18px; box-shadow: 0 20px 60px rgba(2,6,23,.25); overflow: hidden; }
    .modal-head   { padding: 18px 22px; font-weight: 800; font-size: 20px; }
    .modal-close  { position:absolute; right:16px; top:12px; font-size:40px; color:#94a3b8; }
    .modal-close:hover { color:#475569; }

    .total-box{
      background:#eaf2ff; border-radius:14px; padding:14px 16px; min-width: 260px;
      text-align:right; box-shadow: inset 0 0 0 1px rgba(37,99,235,.08);
    }
    .total-box .label{ color:#64748b; font-size:13px; margin-bottom:2px; }
    .total-box .value{ color:#1d4ed8; font-weight:800; font-size:28px; line-height:1.1; }

    .table-shell{ border:1px solid #e2e8f0; border-radius:14px; overflow:hidden; position:relative; }
    .table-head{ background:#f1f5f9; color:#64748b; font-size:14px; padding:10px 16px; position:relative; }
    .detail-row {
  padding:12px 16px;
  display:grid;
  grid-template-columns: 72px 1.4fr 0.7fr 0.9fr 0.9fr; /* ‡∏•‡∏≥‡∏î‡∏±‡∏ö | ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô | ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢ | ‡∏£‡∏ß‡∏° */
  align-items:center;
  gap:12px;
}
    .detail-row + .detail-row { border-top:1px solid #f1f5f9; }
    .col-right{ text-align:right; }
    .bold{ font-weight:700; }

    .disabled { opacity:.5; pointer-events:none; }
    
    /* ===== Overlay + Toast ===== */
#appOverlay.show { display:flex !important; }
#appToast.show   { display:block !important; animation: toastIn .18s ease-out; }
@keyframes toastIn { from{opacity:.3; transform:translate(-50%,8px)} to{opacity:1; transform:translate(-50%,0)} }
.toast-success{ background:linear-gradient(135deg,#16a34a,#059669); }
.toast-error  { background:linear-gradient(135deg,#dc2626,#b91c1c); }
.toast-warn   { background:linear-gradient(135deg,#f59e0b,#d97706); }

    /* ‡πÑ‡∏°‡πà scale ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ fixed-overlay ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô‡∏Å‡∏£‡∏≠‡∏ö */
#appRoot{
  width: 100%;
  overflow-x: hidden;
  min-height: 100vh;
}

/* ‡∏õ‡∏£‡∏±‡∏ö modal ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏à‡∏≠‡πÄ‡∏™‡∏°‡∏≠ */
.modal-overlay{ padding:16px; }                 /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏ì‡∏∞‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
.modal-card{
  width: min(980px, 96vw);                       /* ‡πÅ‡∏Ñ‡∏ö‡∏•‡∏á‡∏ô‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏ö */
  max-height: 88vh;                              /* ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏π‡∏á‡∏à‡∏≠ */
  overflow: auto;                                /* ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡πÉ‡∏´‡πâ‡∏™‡∏Å‡∏£‡∏≠‡∏•‡∏•‡πå‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á */
  border-radius: 18px;
}
    @media (max-width: 640px){
  .modal-card{ width: 98vw; max-height: 90vh; }
}
    /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏° */
.modal-card{
  width: min(980px, 96vw);
  max-height: 88vh;
  overflow: auto;
  border-radius: 18px;
}

/* ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
.modal-card.compact{
  width: min(760px, 90vw);      /* ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ ‡∏•‡∏≠‡∏á 700px ‡∏´‡∏£‡∏∑‡∏≠ 680px */
  max-height: 84vh;             /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏•‡∏á‡∏ô‡∏¥‡∏î ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö */
}

/* ‡∏´‡∏±‡∏ß‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö */
.modal-card.compact .modal-head{
  padding: 14px 18px;           /* ‡πÄ‡∏î‡∏¥‡∏° 18px 22px */
  font-size: 18px;              /* ‡πÄ‡∏î‡∏¥‡∏° 20px */
}

/* ‡∏ï‡∏±‡∏ß‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤: ‡∏•‡∏î padding */
.modal-card.compact .modal-body{
  padding: 14px 18px;           /* ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà px-5 pb-5 */
}

/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏ô‡∏¥‡∏î */
.modal-card.compact .total-box .value{
  font-size: 24px;              /* ‡πÄ‡∏î‡∏¥‡∏° 28px */
}

/* ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
.modal-card.compact .table-head{
  padding: 8px 12px;            /* ‡πÄ‡∏î‡∏¥‡∏° 10px 16px */
  font-size: 13px;
}
.modal-card.compact .detail-row{
  padding: 10px 12px;           /* ‡πÄ‡∏î‡∏¥‡∏° 12px 16px */
  gap: 8px;                     /* ‡πÄ‡∏î‡∏¥‡∏° 12px */
  grid-template-columns: 56px 1.3fr 0.7fr 0.8fr 0.8fr; /* ‡πÄ‡∏î‡∏¥‡∏° 72px ... */
}
.modal-card.compact .status-badge-big{
  font-size: 16px;              /* ‡πÄ‡∏î‡∏¥‡∏° 18px */
  padding: 6px 12px;
}
    /* ===== ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î compact ===== */
.modal-card.compact {
  font-size: 14px;             /* ‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á */
  line-height: 1.4;
}

.modal-card.compact .modal-head {
  font-size: 18px;             /* ‡∏´‡∏±‡∏ß‡∏•‡∏î‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
}

.modal-card.compact .text-slate-500,
.modal-card.compact .field-label {
  font-size: 13px;             /* ‡∏õ‡πâ‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ */
}

.modal-card.compact .font-semibold,
.modal-card.compact .field-value {
  font-size: 14px;             /* ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á */
}

/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° */
.modal-card.compact .total-box .label {
  font-size: 12.5px;
}
.modal-card.compact .total-box .value {
  font-size: 22px !important;  /* ‡πÄ‡∏î‡∏¥‡∏° 28 ‚Üí ‡∏•‡∏î 2 ‡∏£‡∏∞‡∏î‡∏±‡∏ö */
}

/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÇ‡∏°‡∏î‡∏≠‡∏• */
.modal-card.compact .detail-row {
  font-size: 13px;
}

/* ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏ç‡πà */
.modal-card.compact .status-badge-big {
  font-size: 15px;
  padding: 6px 10px;
}

/* ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå (‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°) */
.modal-card.compact textarea#dComment {
  font-size: 13px;
  padding: 8px 10px;
}

.modal-card.compact #detailButtons button {
  font-size: 13px;
  padding: 6px 14px;
  border-radius: 10px;
}

    /* ===== Viewport scale 90% ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ overlay/fixed ===== */
.app-viewport{
  transform: scale(.9);
  transform-origin: top center;
  width: 100%;
  margin: 0 auto;
  display: block;
}

.table-scroll{
  overflow-x: auto !important;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch; /* ‚úÖ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
}

/* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏™‡∏¥‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡∏à‡∏≠‡πÅ‡∏Ñ‡∏ö) */
.grid-head,
.grid-row{
  min-width: 920px;   /* ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ 880‚Äì1040 ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏™‡∏≤‡∏¢‡∏ï‡∏≤ */
}
   @media (max-width: 640px){
  .app-viewport{
    transform: none !important;   /* ‚úÖ ‡πÄ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏µ‡∏ö */
    width: 100% !important;       /* ‚úÖ ‡πÉ‡∏ä‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡∏à‡∏£‡∏¥‡∏á */
    max-width: 100% !important;
    padding: 0 16px;              /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° margin ‡∏Å‡∏±‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ä‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
    margin: 0 auto;
  }
}
    html {
  overflow-x: hidden;
}
body {
  overflow-x: visible;
}


    
  </style>
</head>
<body>
  
<div id="appRoot">
  <!-- ========== VERIFY ========== -->
  <section id="verifyScreen" class="min-h-screen flex items-center justify-center px-4">
  <div class="app-viewport w-full max-w-3xl text-center">
      <div class="flex items-center justify-center">
        <img class="logo" alt="BJC Big C" src="https://i.postimg.cc/B6wpk3yh/cropped-Logo-BJC-Big-C-2021-2048x606.png">
      </div>

      <h1 class="mt-6 text-3xl md:text-4xl font-extrabold title">APPROVAL STATIONERY STORE</h1>
      <div class="divider"></div>

      <p class="mt-5 text-slate-600">
        üè¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô<br>
      </p>

      <div class="mt-7 mx-auto card shadow-soft animate-[fadeIn_.25s_ease-out]">
        <form id="verifyForm" class="text-left">
          <label for="empCode" class="block text-base text-slate-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</label>
          <input id="empCode" name="empCode" type="text" inputmode="numeric" autocomplete="off" required
       class="mt-2 w-full rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 px-4 py-3 outline-none text-sm"
       placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">

          <button id="submitBtn" type="submit"
  class="mt-4 w-full bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-xl py-3 transition-all flex items-center justify-center gap-2 active:translate-y-[1px]">
  <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</span>
            
            <svg id="loadingIcon" class="hidden animate-spin" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="white" stroke-width="4"></circle>
              <path class="opacity-75" d="M4 12a8 8 0 018-8" stroke="white" stroke-width="4" stroke-linecap="round"></path>
            </svg>
          </button>

          <p id="hint" class="mt-3 text-sm text-rose-600 hidden hint-error">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
        </form>
      </div>
    </div>
  </section>

  <!-- ========== APPROVAL ========== -->
  <section id="approvalScreen" class="hidden">
  <div class="app-viewport">
    <main class="max-w-6xl mx-auto px-4 pt-5 pb-2">
      <div class="flex items-center justify-center mb-3">
        <img src="https://i.postimg.cc/B6wpk3yh/cropped-Logo-BJC-Big-C-2021-2048x606.png" alt="BJC Big C" class="h-7 md:h-9 object-contain">
      </div>

      <h1 class="text-3xl md:text-4xl font-extrabold text-center">APPROVAL STATIONERY STORE</h1>
      <div class="title-underline mx-auto mt-2 mb-6"></div>

      <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -->
      <section class="info-card">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 rounded-full bg-indigo-100 flex items-center justify-center shrink-0">
            <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor" class="text-indigo-500">
              <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-5.33 0-8 2.67-8 5v1h16v-1c0-2.33-2.67-5-8-5z"/>
            </svg>
          </div>

          <div class="w-full">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="field-label">Name</div>
                <div id="apvName" class="field-value">‚Äî</div>
              </div>
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="field-label">Email</div>
                <div id="apvEmail" class="field-value">‚Äî</div>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="field-label">Company</div>
                <div id="apvCompany" class="field-value">‚Äî</div>
              </div>
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="field-label">Division</div>
                <div id="apvDivision" class="field-value">‚Äî</div>
              </div>
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="field-label">Cost Center</div>
                <div id="apvCost" class="field-value">‚Äî</div>
              </div>
            </div>
            <div class="mt-2 text-sm text-slate-500 flex items-center justify-between">
  <span id="apvType">Type: ‚Äî</span>

 <button id="logoutBtn"
  class="px-3 py-1.5 rounded-lg border bg-rose-50 text-rose-700 border-rose-200
         hover:bg-rose-100 active:translate-y-[1px]
         text-xs md:text-sm transition-all">
  ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
</button>
          </div>
        </div>
      </section>

      <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ + ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå -->
      <section class="mt-6">
        <div class="mb-3">
          <div class="text-xl md:text-2xl font-semibold">Approval Items</div>
          <div class="text-sm text-slate-500 -mt-0.5">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
        </div>

        <div class="flex flex-wrap items-center justify-start gap-2 md:gap-4">
  <div class="flex flex-wrap gap-2">
    <button class="status-chip active" data-status="ALL">All items</button>
    <button class="status-chip" data-status="WAITING">Waiting for approval</button>
    <button class="status-chip" data-status="APPROVE">Approve</button>
    <button class="status-chip" data-status="REJECT">Reject</button>
  </div>

  <!-- ‡∏Ç‡∏¢‡∏±‡∏ö‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏±‡∏ô‡∏Ç‡∏≠‡∏ö ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏° -->
  <div
    id="reqCount"
    class="mt-3 md:mt-0 text-slate-600 font-medium text-[14px]
           whitespace-nowrap
           w-full sm:w-auto
           sm:ml-auto sm:mr-4 md:mr-6 lg:mr-8">
    Total: 0 Requests
  </div>
</div>

<div class="mt-3 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
  <div class="table-scroll">
    <div class="grid-head">
      <div>Request Number</div>
      <div>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</div>
      <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</div>
      <div class="col-center">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
      <div class="col-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
      <div class="col-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
      <div class="col-left pl-2 md:pl-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
    </div>
    <div id="reqList"></div>
  </div>

  <div id="pager"
       class="px-4 py-3 border-t border-slate-100
              flex items-center justify-between text-sm text-slate-600">
  </div> <!-- ‚úÖ ‡∏õ‡∏¥‡∏î pager -->
</div>
        
    </main>
    </div>
  </section>

  <!-- ========== MODAL ========= -->
  <div id="detailOverlay" class="fixed inset-0 hidden items-center justify-center modal-overlay z-[60]">
  <div class="bg-white relative modal-card compact"> <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° class compact -->
    <button class="modal-close" onclick="closeDetail()" aria-label="Close">√ó</button>
    <div class="modal-head mt-5 md:mt-7 pb-0">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
    <div class="modal-body px-5 pb-5">
        <!-- ‡∏ã‡πâ‡∏≤‡∏¢ 2 ‡πÅ‡∏ñ‡∏ß 4 ‡∏Å‡∏•‡πà‡∏≠‡∏á | ‡∏Ç‡∏ß‡∏≤ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å + ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏ß‡∏° -->
        <div class="grid grid-cols-1 lg:grid-cols-[1.2fr,0.8fr] gap-6 mb-2 lg:mb-6">
          <!-- ‡∏ã‡πâ‡∏≤‡∏¢ -->
          <div class="space-y-4">
            <!-- ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô: Request Number + ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="text-slate-500 text-sm">Request Number</div>
                <div id="dReqNo" class="font-semibold">‚Äî</div>
              </div>
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="text-slate-500 text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</div>
                <div id="dDate" class="font-semibold">‚Äî</div>
              </div>
            </div>
            <!-- ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á: ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞(‡πÉ‡∏´‡∏ç‡πà) -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="text-slate-500 text-sm">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</div>
                <div id="dRequester" class="font-semibold">‚Äî</div>
              </div>
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="text-slate-500 text-sm mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
                <div><span id="dStatusBig" class="status-badge-big">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span></div>
              </div>
            </div>
          </div>

          <!-- ‡∏Ç‡∏ß‡∏≤ -->
          <div>
            <div id="dItemCountLabel" class="text-sm text-slate-500 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            <div class="total-box w-full mb-4">
              <div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</div>
              <div id="dTotal" class="value">0 ‡∏ö‡∏≤‡∏ó</div>
            </div>
          </div>
        </div>

<div class="table-shell">
  <div class="table-head">
    <span class="font-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</span>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ß‡∏≤‡∏á "‡∏ô‡∏≠‡∏Å" .table-head) -->
  <div class="detail-row text-slate-600 font-medium bg-slate-50">
    <div class="col-center">‡∏•‡∏≥‡∏î‡∏±‡∏ö</div>
    <div>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
    <div class="col-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
    <div class="col-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</div>
    <div class="col-right">‡∏£‡∏ß‡∏°</div>
  </div>

  <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
  <div id="dItems"></div>
</div>

        <!-- ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå + ‡∏õ‡∏∏‡πà‡∏° -->
        <div class="mt-5">
          <label class="text-sm text-slate-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (Comment)</label>
          <textarea id="dComment" rows="3" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 outline-none focus:ring-4 focus:ring-blue-100"></textarea>
        </div>
        <div id="detailButtons" class="mt-6 flex flex-wrap gap-2 justify-end"></div>
      </div>
    </div>
  </div>
  </div> <!-- ‡∏õ‡∏¥‡∏î #appRoot -->
  
  <!-- ===== Loading Overlay ===== -->
<div id="appOverlay" class="hidden fixed inset-0 z-[90] flex items-center justify-center bg-black/40">
  <div class="rounded-2xl bg-white px-5 py-4 shadow-xl text-slate-700 flex items-center gap-3">
    <svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" d="M4 12a8 8 0 018-8" stroke="currentColor" stroke-width="4" stroke-linecap="round"></path>
    </svg>
    <span id="appOverlayText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</span>
  </div>
</div>

<!-- ===== Toast (Success / Error / Warn) ===== -->
<div id="appToast" class="hidden fixed left-1/2 -translate-x-1/2 bottom-6 z-[95]">
  <div id="appToastCard" class="px-4 py-3 rounded-xl shadow-lg text-white font-medium min-w-[280px] text-center">
    <span id="appToastText">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span>
  </div>
</div>


  <script>
/* ===== CONFIG ===== */
const SHEET_ID     = '15Nzap1xe_qkcBoVskRTMG7o7Gb_zE8nTRm8rY3VeMmg';
const SHEET_USER   = 'User Approve';
const SHEET_RESP   = 'Response';
const API_BASE     = 'https://script.google.com/macros/s/AKfycbyUDaiiIRN2_OfWgqiusRYivGmed5Gj0K8_Ry5ogXlNRx854YHvsWizjr83jHQkxcO4Cw/exec';

/* ===== Utils ===== */
function showPage(which){
  const verify = document.getElementById('verifyScreen');
  const appr   = document.getElementById('approvalScreen');
  if(which === 'approval'){ verify.classList.add('hidden'); appr.classList.remove('hidden'); window.scrollTo(0,0); }
  else { appr.classList.add('hidden'); verify.classList.remove('hidden'); }
}
function setLoading(on){
  const btn = document.getElementById('submitBtn');
  const icon = document.getElementById('loadingIcon');
  btn.disabled = on; icon.classList.toggle('hidden', !on); btn.style.opacity = on ? .85 : 1;
}
function showHint(msg){ const el = document.getElementById('hint'); el.textContent = msg || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'; el.classList.remove('hidden'); }
function hideHint(){ document.getElementById('hint').classList.add('hidden'); }

function gvizUrl(sheetName, tq){
  const qs = new URLSearchParams({ tqx:'out:json', sheet: sheetName, tq });
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?` + qs.toString();
}
async function fetchGVizRows(url){
  const res = await fetch(url, { cache:'no-store' });
  const txt = await res.text();
  const m = txt.match(/setResponse\(([\s\S]*)\);?$/);
  if(!m) throw new Error('Bad GViz');
  const json = JSON.parse(m[1]);
  const cols = json.table.cols.map(c=>c.label || c.id || '');
  const rows = json.table.rows.map(r => {
    const obj = {};
    r.c.forEach((c,i)=> obj[cols[i] || `c${i}`] = c ? c.v : null );
    obj._arr = r.c.map(c => c ? c.v : null);
    obj._fmt = r.c.map(c => (c && c.f) ? c.f : null);
    return obj;
  });
  return rows;
}
function pad(n){ return n<10 ? '0'+n : ''+n; }
function formatDDMMYYYY(val, formatted){
  if (formatted && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(formatted)) return formatted.split('/').map((x,i)=> i<2?pad(+x):x).join('/');
  if (typeof val === 'string' && /Date\(\d+,\d+,\d+/.test(val)) {
    const m = val.match(/Date\((\d+),(\d+),(\d+)/); if (m) return pad(+m[3])+'/'+pad(+m[2]+1)+'/'+m[1];
  }
  const d = new Date(val); if (!isNaN(d.getTime())) return pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear();
  if (typeof val === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(val)) {
    const [d2,m2,y2] = val.split('/').map(x=>+x); return pad(d2)+'/'+pad(m2)+'/'+y2;
  }
  return String(val || '‚Äî');
}
    function toNum(v){
  if (v == null) return 0;
  // ‡πÅ‡∏Å‡πâ‡πÄ‡∏Ñ‡∏™‡∏™‡∏ï‡∏£‡∏¥‡∏á 'NaN', ‡∏Ñ‡∏≠‡∏°‡∏°‡∏≤, ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
  const n = Number(String(v).replace(/[, ]/g,''));
  return Number.isFinite(n) ? n : 0;
}
 // === ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å GViz (Date/number/string) ‡πÄ‡∏õ‡πá‡∏ô milliseconds ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ sort ‡∏ï‡∏≤‡∏° "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà + ‡πÄ‡∏ß‡∏•‡∏≤" ===
function toMsFromGviz(val){
  if (val == null) return 0;
  if (Object.prototype.toString.call(val) === '[object Date]') {
    const ms = val.getTime();
    return Number.isFinite(ms) ? ms : 0;
  }

  const s = String(val).trim();
  
 // 2) ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö GViz: Date(YYYY,MM,DD[,hh,mm,ss])
  {
    const m = s.match(/Date\((\d+),(\d+),(\d+)(?:,(\d+),(\d+),(\d+))?\)/);
    if (m) {
      const Y = +m[1], M = +m[2], D = +m[3],
            h = +(m[4]||0), mi = +(m[5]||0), se = +(m[6]||0);
      const ms = new Date(Y, M, D, h, mi, se).getTime();
      return Number.isFinite(ms) ? ms : 0;
    }
  }

  // 3) ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç: ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô ms ‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô serial/day number ‚Üí ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏î‡∏≤
  if (!Number.isNaN(+s) && s !== '') {
    const num = +s;
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà" ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô epoch ms
    if (num > 1e10) return num;
    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ serial ‡∏ß‡∏±‡∏ô‡∏Ç‡∏≠‡∏á Sheets (‡πÄ‡∏£‡∏¥‡πà‡∏° 1899-12-30)
    if (num > 10000 && num < 100000) {
      const base = new Date(Date.UTC(1899, 11, 30)).getTime();
      return base + Math.round(num * 24 * 60 * 60 * 1000);
    }
    // ‡∏•‡∏≠‡∏á‡∏ï‡∏µ‡πÄ‡∏õ‡πá‡∏ô epoch ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    if (num > 1e5 && num < 1e10) return num * 1000;
  }

  // 4) dd/mm/yyyy HH:MM[:SS] (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á)
  {
    const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
    if (m) {
      const d = +m[1], mn = +m[2], y = +m[3],
            hh = +(m[4]||0), mm = +(m[5]||0), ss = +(m[6]||0);
      const ms = new Date(y, mn - 1, d, hh, mm, ss).getTime();
      return Number.isFinite(ms) ? ms : 0;
    }
  }

  // 5) ‡∏ü‡∏≠‡∏•‡πÅ‡∏ö‡πá‡∏Ñ: ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ Date.parse ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ISO)
  const ms2 = Date.parse(s);
  return Number.isFinite(ms2) ? ms2 : 0;
}
    
    /* ===== Overlay / Toast Helpers ===== */
function showOverlay(text){
  const ov = document.getElementById('appOverlay');
  const tx = document.getElementById('appOverlayText');
  if (tx) tx.textContent = text || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶';
  ov.classList.add('show'); ov.classList.remove('hidden');
}
function hideOverlay(){
  const ov = document.getElementById('appOverlay');
  ov.classList.remove('show'); ov.classList.add('hidden');
}
let toastTimer = null;
function toast(message, type='success', ms=1800){
  const wrap = document.getElementById('appToast');
  const card = document.getElementById('appToastCard');
  const text = document.getElementById('appToastText');
  if (!wrap || !card || !text) return;

  text.textContent = message || '';
  card.classList.remove('toast-success','toast-error','toast-warn');
  if (type === 'error') card.classList.add('toast-error');
  else if (type === 'warn') card.classList.add('toast-warn');
  else card.classList.add('toast-success');

  wrap.classList.add('show'); wrap.classList.remove('hidden');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ wrap.classList.remove('show'); wrap.classList.add('hidden'); }, ms);
}

/* ===== Approver Header ===== */
function fillApprover(ap){
  document.getElementById('apvName').textContent     = ap.name || '‚Äî';
  document.getElementById('apvEmail').textContent    = ap.email || '‚Äî';
  document.getElementById('apvCompany').textContent  = ap.company || '‚Äî';
  document.getElementById('apvDivision').textContent = ap.division || '‚Äî';
  document.getElementById('apvCost').textContent     = ap.costCenter || '‚Äî';
  document.getElementById('apvType').textContent     = ap.type ? `Type: ${ap.type}` : 'Type: ‚Äî';
}

/* ===== Role routing ===== */
function getSourceByType(type){
  const t = String(type||'').trim().toUpperCase();
  if (t === 'ADMIN')    return { sheet: 'Admin',    statusIdx: 14, actedIdx: 16 }; // O
  if (t === 'BU ADMIN') return { sheet: 'BU Admin', statusIdx: 15, actedIdx: 17 }; // P
  if (t === 'BU HEAD')  return { sheet: 'BU Head',  statusIdx: 16, actedIdx: 18 }; // Q
  return null;
}

/* ===== VERIFY ===== */
let APPROVER = null;
document.getElementById('verifyForm').addEventListener('submit', async (e)=>{
  e.preventDefault(); hideHint();
  const code = document.getElementById('empCode').value.trim();
  if(!code){ showHint('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return; }

  setLoading(true);
  try{
    const tqU = `select A,B,C,D,E,F,G where A='${code.replace(/'/g,"\\'")}'`;
    const [rec] = await fetchGVizRows(gvizUrl(SHEET_USER, tqU));
    if(!rec){ showHint('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'); return; }

    APPROVER = {
      empCode:    rec._arr?.[0] ?? code,
      name:       rec._arr?.[1] ?? '',
      email:      rec._arr?.[2] ?? '',
      company:    rec._arr?.[3] ?? '',
      division:   rec._arr?.[4] ?? '',
      costCenter: rec._arr?.[5] ?? '',
      type:       rec._arr?.[6] ?? '',
      verifiedAt: new Date().toISOString()
    };
    sessionStorage.setItem('approver', JSON.stringify(APPROVER));

    fillApprover(APPROVER);

    const src = getSourceByType(APPROVER.type);
    if(!src){ alert('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå'); return; }

    showPage('approval');
    await loadAndRenderList('ALL');
  }catch(err){
    console.error(err);
    showHint('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
  }finally{ setLoading(false); }
});

/* ===== LIST + FILTERS ===== */
let SOURCE_ROWS = [];
let CURRENT_FILTER = 'ALL';
let CURRENT_DETAIL = null;

const PAGE_SIZE = 20;
let CURRENT_PAGE = 1;
let FILTERED_ROWS = [];

/* ===== ACTED ORDER (‡∏à‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏≠‡πá‡∏Å‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Request) ===== */
let ACTED_AT = {};
(function initActedAt(){
  try {
    const raw = sessionStorage.getItem('actedAt') || '{}';
    ACTED_AT = JSON.parse(raw);
  } catch { ACTED_AT = {}; }
})();
function markActed(reqNo){
  if (!reqNo) return;
  const key = String(reqNo).trim(); // normalize key
  ACTED_AT[key] = Date.now();
  try { sessionStorage.setItem('actedAt', JSON.stringify(ACTED_AT)); } catch {}
}
function getActedAt(reqNo){
  const key = String(reqNo).trim(); // normalize key
  return Number(ACTED_AT[key] || 0);
}


function normalizeStatus(txt){
  const s = String(txt || '').trim();
  const u = s.toUpperCase();

  // ‡∏ß‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏±‡∏î‡∏ß‡πà‡∏≤ "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ‚Üí WAITING
  if (!s || u.includes('WAIT') || s.includes('‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')) return 'WAITING';

  if (u.includes('APPROVE') || u.includes('SUBMIT') || s.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')) return 'APPROVE';
  if (u.includes('REJECT')  || s.includes('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò')) return 'REJECT';

  // ‡∏î‡∏µ‡∏ü‡∏≠‡∏•‡∏ï‡πå‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏∞‡∏Å‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‚Üí ‡∏à‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô WAITING ‡∏à‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤
  return 'WAITING';
}
    
function statusClass(norm){
  const t = (norm||'').toUpperCase();
  if (t==='APPROVE') return 'approve';
  if (t==='REJECT') return 'reject';
  return 'waiting';
}
function isApproved(raw){
  const s = String(raw||'').trim();
  if (!s) return false;
  if (s === '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') return false;
  const u = s.toUpperCase();
  return u.includes('APPROVE') || s.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
}

    

async function loadAndRenderList(filter){
  CURRENT_FILTER = filter || CURRENT_FILTER;

  if (!APPROVER){
    const raw = sessionStorage.getItem('approver');
    if(raw){ try{ APPROVER = JSON.parse(raw); fillApprover(APPROVER);}catch{} }
  }
  const src = getSourceByType(APPROVER?.type);
  if(!src){ document.getElementById('reqList').innerHTML = '<div class="px-4 py-3 text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</div>'; return; }

  if (SOURCE_ROWS.length === 0) {
    const tqS = 'select *';
    SOURCE_ROWS = await fetchGVizRows(gvizUrl(src.sheet, tqS));

    // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå N (index 13) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö BU Admin / BU Head
    const t = String(APPROVER?.type||'').toUpperCase();
    if (t === 'BU ADMIN' || t === 'BU HEAD') {
      const emp = String(APPROVER?.empCode || '').trim();
      SOURCE_ROWS = SOURCE_ROWS.filter(r => String((r._arr||[])[13] || '').trim() === emp);
    }
  }

  const idxA = 0, idxB = 1, idxG = 6, idxL = 11, idxM = 12, idxStatus = src.statusIdx;

  let rows = SOURCE_ROWS.map((r, _idx) => ({ ...r, _idx })).filter(r=>{
    const arr = r._arr || [];
    const raw = String(arr[idxStatus] || '').trim();
    if (CURRENT_FILTER === 'ALL') return true;
    if (CURRENT_FILTER === 'WAITING') return raw === '';
    const disp = raw || '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
    const norm = normalizeStatus(disp);
    return norm === CURRENT_FILTER;
  });

  rows.sort((r1, r2)=>{
    const a1 = r1._arr||[], a2 = r2._arr||[];
    const rno1 = String(a1[idxA]||'');
    const rno2 = String(a2[idxA]||'');

    const raw1 = String(a1[idxStatus]||'').trim();
    const raw2 = String(a2[idxStatus]||'').trim();
    // ‡∏Å‡∏•‡∏∏‡πà‡∏° 0 = WAITING (‡∏ß‡πà‡∏≤‡∏á), ‡∏Å‡∏•‡∏∏‡πà‡∏° 1 = ACTED (‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß)
    const g1 = raw1 === '' ? 0 : 1;
    const g2 = raw2 === '' ? 0 : 1;
    // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ó‡πá‡∏ö All: ‡πÉ‡∏´‡πâ WAITING ‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô, ACTED ‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏á
    if (CURRENT_FILTER === 'ALL') {
      if (g1 !== g2) return g1 - g2;
    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏∏‡πà‡∏° WAITING ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠
      if (g1 === 0) {
        return rno1.localeCompare(rno2, 'th');
    }
      
    // ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡πÄ‡∏õ‡πá‡∏ô ACTED ‚Üí ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ActedAt
    const actedIdx = src.actedIdx;
    const t1Sheet = toMsFromGviz(a1[actedIdx]) || 0;
    const t2Sheet = toMsFromGviz(a2[actedIdx]) || 0;
      
    const t1 = t1Sheet || getActedAt(rno1) || 0;
    const t2 = t2Sheet || getActedAt(rno2) || 0;
    // ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‚Äú‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô ‚Üí ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏á‚Äù ‡πÉ‡∏ô‡∏Å‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏á 
    if (t1 !== t2) return t2 - t1; // DESC by actedAt
    return rno1.localeCompare(rno2, 'th');
    }
    
    const s1 = String(a1[idxStatus]||'').trim();
    const s2 = String(a2[idxStatus]||'').trim();
    const ap1 = isApproved(s1) ? 1 : 0;
    const ap2 = isApproved(s2) ? 1 : 0;
    if (ap1 !== ap2) return ap1 - ap2;

    // ‡∏´‡∏≤‡∏Å‡∏à‡∏∞‡∏¢‡∏∂‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡πá‡∏ó‡∏≥‡πÑ‡∏î‡πâ:
    const actedIdx2 = src.actedIdx;
    const t1s = toMsFromGviz(a1[actedIdx2]) || 0;
    const t2s = toMsFromGviz(a2[actedIdx2]) || 0;
    const tt1 = t1s || getActedAt(rno1) || 0;
    const tt2 = t2s || getActedAt(rno2) || 0;
    if (tt1 !== tt2) return tt2 - tt1; // ‡πÉ‡∏´‡∏°‡πà‡∏ö‡∏ô/‡πÄ‡∏Å‡πà‡∏≤‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô

    return rno1.localeCompare(rno2, 'th');
  });

 // NEW: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤
FILTERED_ROWS = rows;

// NEW: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î + clamp ‡∏´‡∏ô‡πâ‡∏≤
const totalPages = Math.max(1, Math.ceil(rows.length / PAGE_SIZE));
CURRENT_PAGE = Math.min(Math.max(1, CURRENT_PAGE), totalPages);

// NEW: ‡∏ï‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
const start = (CURRENT_PAGE - 1) * PAGE_SIZE;
const rowsPage = rows.slice(start, start + PAGE_SIZE);

document.getElementById('reqCount').textContent = `Total: ${rows.length} Requests`;

// Render ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ rows ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
const host = document.getElementById('reqList');
host.innerHTML = rowsPage.map((r, i) => {
  const arr     = r._arr || [];
  const fmt     = r._fmt || [];

  const reqNo   = arr[idxA] ?? '‚Äî';
  const reqBy   = arr[idxG] ?? '‚Äî';
  const reqDate = formatDDMMYYYY(arr[idxB], fmt[idxB]);
  const items   = arr[idxL] ?? '‚Äî';
  const total   = arr[idxM] ?? 0;

  const rawStatus     = String(arr[idxStatus] || '').trim();
  const displayStatus = rawStatus || '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
  const pillClass     = rawStatus === '' ? 'waiting' : statusClass(normalizeStatus(displayStatus));

    return `
  <div class="grid-row">
    <div class="text-blue-700 font-semibold whitespace-nowrap">${reqNo}</div>
    <div class="truncate">${reqBy || '‚Äî'}</div>
    <div>${reqDate || '‚Äî'}</div>
    <div class="truncate col-center text-center">${items || '‚Äî'}</div>

    <div class="text-right font-semibold">${Number(total||0).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
      ${(() => {
        const actedIdx = src.actedIdx;
        const tSheet = toMsFromGviz(arr[actedIdx]) || 0;
        const tLocal = getActedAt(String(arr[0] || '')) || 0;
        const tip = (tSheet || tLocal) ? new Date(tSheet || tLocal).toLocaleString() : '-';
        return `
          <div class="col-center">
            <span class="status-pill ${pillClass}" title="ActedAt: ${tip}">${displayStatus}</span>
          </div>`;
      })()}
      <div class="col-left pl-2 md:pl-3">
        <button class="px-3 py-1.5 rounded-xl bg-blue-600 text-white hover:brightness-105"
                onclick='openDetail(${JSON.stringify({i: r._idx}).replace(/"/g,"&quot;")})'>
          ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        </button>
      </div>
  </div>`;
}).join('');

// NEW: ‡∏ß‡∏≤‡∏î‡πÄ‡∏û‡∏à‡πÄ‡∏à‡∏≠‡∏£‡πå
renderPager(totalPages);
}

/* ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.status-chip');
  if(!btn) return;
  document.querySelectorAll('.status-chip').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  CURRENT_PAGE = 1;                 // NEW: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ 1 ‡πÄ‡∏™‡∏°‡∏≠
  loadAndRenderList(btn.dataset.status);
});

/* ===== DETAIL ===== */
let DETAIL_LINES = [];

function parseLineItemsFromResponseRow(arr){
  const out = [];
  const START = 13;
  
  for (let i = START; i < arr.length; i += 3) {
    const name  = arr[i];
    const qty   = toNum(arr[i+1]);
    const price = toNum(arr[i+2]);
     if ((!name || String(name).trim()==='') && qty === 0 && price === 0) continue;
     out.push({ name: name || '-', qty, price, sum: qty * price });
  }
  return out;
}
    
function renderDetailButtons(type, acted){
  const box = document.getElementById('detailButtons');
  const btnClose   = `<button class="px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300" onclick="closeDetail()">‡∏õ‡∏¥‡∏î</button>`;
  const btnApprove = `<button class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:brightness-105" onclick="actOnCurrent('APPROVE')">Approve</button>`;
  const btnReject  = `<button class="px-4 py-2 rounded-xl bg-rose-600 text-white hover:brightness-105" onclick="actOnCurrent('REJECT')">Reject</button>`;

  // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  if (acted) { box.innerHTML = `${btnClose}`; return; }

  // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Approve/Reject
  box.innerHTML = `${btnClose} ${btnApprove} ${btnReject}`;
}
    
function recalcTotals(){
  let total = 0;
  DETAIL_LINES.forEach(li => li.sum = (Number(li.qty)||0) * (Number(li.price)||0));
  DETAIL_LINES.forEach(li => total += li.sum);
  document.getElementById('dTotal').textContent = `${total.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
}
function renderDetailItems(){
  const host = document.getElementById('dItems');
  if (!DETAIL_LINES.length){
    host.innerHTML = `
      <div class="detail-row text-slate-500 text-sm">
        <div style="grid-column:1 / -1">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢</div>
      </div>`;
    return;
  }
  host.innerHTML = DETAIL_LINES.map((li, idx) => {
    return `
      <div class="detail-row">
        <div class="col-center">${idx + 1}</div>
        <div>${li.name}</div>
        <div class="col-right">${(li.qty).toLocaleString()}</div>
        <div class="col-right">${(li.price).toLocaleString()}</div>
        <div class="col-right bold">${(li.sum).toLocaleString()}</div>
      </div>`;
  }).join('');
}
        
    /* ===== Comment Cache (persist ‡∏ï‡πà‡∏≠‡πÉ‡∏ö) ===== */
let COMMENT_CACHE = (() => {
  try { return JSON.parse(sessionStorage.getItem('commentCache') || '{}'); }
  catch { return {}; }
})();

function getComment(reqNo){
  const k = String(reqNo || '').trim();
  return COMMENT_CACHE[k] || '';
}
function setComment(reqNo, text){
  const k = String(reqNo || '').trim();
  COMMENT_CACHE[k] = text || '';
  try { sessionStorage.setItem('commentCache', JSON.stringify(COMMENT_CACHE)); } catch {}
}

async function openDetail({i}){
  CURRENT_DETAIL = i;

  const srcRow = SOURCE_ROWS[i]; 
  if(!srcRow) return;

  const arr = srcRow._arr || [];
  const fmt = srcRow._fmt || [];
  const src = getSourceByType(APPROVER?.type);
  const idxA=0, idxB=1, idxG=6, idxM=12, idxStatus=src.statusIdx;

  const reqNo   = arr[idxA] ?? '‚Äî';
  const reqDate = formatDDMMYYYY(arr[idxB], fmt[idxB]);
  const reqBy   = arr[idxG] ?? '‚Äî';
  const total   = Number(arr[idxM] ?? 0);
  const rawStatus = String(arr[idxStatus] || '').trim();
  const displayStatus = rawStatus || '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
  const pillClass     = rawStatus === '' ? 'waiting' : statusClass(normalizeStatus(displayStatus));
  const acted         = rawStatus !== '';

// ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡∏Å‡∏•‡πà‡∏≠‡∏á
  document.getElementById('dReqNo').textContent     = reqNo;
  document.getElementById('dDate').textContent      = reqDate;
  document.getElementById('dRequester').textContent = reqBy;

  const big = document.getElementById('dStatusBig');
  big.textContent = displayStatus;
  big.className   = `status-badge-big ${pillClass.replace('waiting','')}`;

  // ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ñ‡πâ‡∏≤ acted ‡πÅ‡∏•‡πâ‡∏ß)
  const commentEl = document.getElementById('dComment');
  if (commentEl){
    commentEl.value = getComment(reqNo);
    if (acted) {
      commentEl.readOnly = true;
      commentEl.classList.add('disabled');
      commentEl.oninput = null;
    } else {
      commentEl.readOnly = false;
      commentEl.classList.remove('disabled');
      commentEl.oninput = (e)=> setComment(reqNo, e.target.value);
    }
  }

   // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï Response
  const tqR = `select * where A='${String(reqNo).replace(/'/g,"\\'")}'`;
  const respRows = await fetchGVizRows(gvizUrl(SHEET_RESP, tqR));
  DETAIL_LINES = (respRows && respRows.length) ? parseLineItemsFromResponseRow(respRows[0]._arr || []) : [];

  document.getElementById('dItemCountLabel').textContent = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å ${DETAIL_LINES.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  document.getElementById('dTotal').textContent = `${(total||0).toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

  renderDetailItems();
  renderDetailButtons(APPROVER?.type, acted);

  const ov = document.getElementById('detailOverlay');
  ov.classList.remove('hidden'); 
  ov.classList.add('flex');
}

    function closeDetail(){
  const ov = document.getElementById('detailOverlay');
  if (!ov) return;
  ov.classList.add('hidden');
  ov.classList.remove('flex');
  CURRENT_DETAIL = null;
}

  
/* ===== ACT ===== */
async function actOnCurrent(type){
  const idx = CURRENT_DETAIL;
  if (idx == null) return;

  const srcRow = SOURCE_ROWS[idx];
  const reqNo  = srcRow?._arr?.[0] || '‚Äî';
  const comment = document.getElementById('dComment').value || '';
  const ap = APPROVER || JSON.parse(sessionStorage.getItem('approver') || '{}');

  try{
    showOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶');
const res = await fetch(API_BASE, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' }, // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å
  body: JSON.stringify({
    action: 'act',
    type,
    requestNo: reqNo,
    approver: ap?.name || '',
    approverEmail: ap?.email || '',
    role: ap?.type || '',
    comment
  })
});

    const rawText = await res.text();
    let data;
    try { data = JSON.parse(rawText); }
    catch (e) {
      console.error('API raw (not JSON):', rawText);
      hideOverlay();
      toast('API ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON','error',2600);
      return;
    }

    if (!res.ok || !data.ok){
      console.error('API error payload:', data);
      hideOverlay();
      toast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (data?.error || (`HTTP ${res.status} ${res.statusText}`)), 'error', 2600);
      return;
    }

    hideOverlay();
    const okMsg = (type === 'APPROVE') ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å';
    const toastType = (type === 'APPROVE') ? 'success' : 'error';
    toast(okMsg, toastType, 1600);

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ oninput ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏á)
    setComment(reqNo, (document.getElementById('dComment')?.value || ''));

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏≥ ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á ‚Äú‡∏Å‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏á‚Äù
    markActed(reqNo);

    closeDetail();
    SOURCE_ROWS = [];                   // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï
    await loadAndRenderList(CURRENT_FILTER);

  }catch(err){
    console.error(err);
    hideOverlay();
    toast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','error',2400);
  }
}
  
    /* NEW: Pager */
function renderPager(totalPages){
  const el = document.getElementById('pager');
  if (!el) return;

  if (totalPages <= 1){
    el.innerHTML = '';   // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏∞‡πÑ‡∏£
    return;
  }

  const canPrev = CURRENT_PAGE > 1;
  const canNext = CURRENT_PAGE < totalPages;

  el.innerHTML = `
    <div>Page ${CURRENT_PAGE} / ${totalPages}</div>
    <div class="flex gap-2">
      <button
        class="px-3 py-1.5 rounded-xl border border-slate-300 bg-white disabled:opacity-50"
        ${canPrev ? '' : 'disabled'}
        onclick="gotoPage(${CURRENT_PAGE - 1})">‚Äπ Prev</button>
      <button
        class="px-3 py-1.5 rounded-xl border border-slate-300 bg-white disabled:opacity-50"
        ${canNext ? '' : 'disabled'}
        onclick="gotoPage(${CURRENT_PAGE + 1})">Next ‚Ä∫</button>
    </div>`;
}

function gotoPage(p){
  const totalPages = Math.max(1, Math.ceil(FILTERED_ROWS.length / PAGE_SIZE));
  CURRENT_PAGE = Math.min(Math.max(1, p), totalPages);
  // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á refetch)
  loadAndRenderList(CURRENT_FILTER);
}

    // ========== Logout (delegated) ==========
document.addEventListener('click', (e) => {
  const btn = e.target.closest('#logoutBtn');
  if (!btn) return;

  // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Verify
  sessionStorage.clear();
  showPage('verify');

  // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÜ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°)
  const emp = document.getElementById('empCode');
  if (emp) emp.value = '';
  window.scrollTo(0,0);
});

  </script>
</body>
</html>

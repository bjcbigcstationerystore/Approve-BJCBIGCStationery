<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>APPROVAL STATIONERY STORE</title>

  <!-- Prompt font -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { prompt: ['Prompt','system-ui','sans-serif'] },
          boxShadow: { soft: '0 10px 30px rgba(2,6,23,.08)' }
        }
      }
    }
  </script>

  <style>
    :root { --card-w: 720px; }
    body{
      font-family:'Prompt',system-ui,sans-serif;
      background:
        radial-gradient(1200px 600px at 50% -200px, rgba(59,130,246,.15), rgba(59,130,246,0)),
        radial-gradient(800px 600px at 80% 0, rgba(99,102,241,.12), rgba(99,102,241,0)),
        linear-gradient(180deg,#eef2ff 0%,#f8fafc 70%);
      min-height:100vh;
      color:#0f172a;
    }
    .card{ width:min(var(--card-w),calc(100% - 32px)); background:#fff; border-radius:20px; box-shadow:var(--tw-shadow,0 20px 60px rgba(2,6,23,.08)); padding:28px; }
    .logo{ width:340px; max-width:80vw; height:auto; filter:drop-shadow(0 6px 18px rgba(2,6,23,.08)); }
    .title{ letter-spacing:.02em; text-shadow:0 2px 0 rgba(255,255,255,.7); }
    .btn-primary{ background:linear-gradient(135deg,#3b82f6,#1d4ed8); }
    .btn-primary:hover{ filter:brightness(1.02); transform:translateY(-1px); }
    .divider{ margin:10px auto 0; width:72px; height:3px; border-radius:999px; background:linear-gradient(90deg,#1d4ed8,#60a5fa); opacity:.85; }
    .hint-error{ animation:fadeIn .15s ease-out; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(-3px)} to{opacity:1; transform:translateY(0)} }

    .title-underline{ width:92px; height:4px; border-radius:999px; background:linear-gradient(90deg,#1d4ed8,#60a5fa); }
    .info-card{ background:#fff; border-radius:18px; padding:18px 20px; box-shadow:var(--tw-shadow,0 20px 60px rgba(2,6,23,.08)); }
    .field-label{ font-size:.78rem; color:#64748b }
    .field-value{ font-weight:600; color:#0f172a }
    .hidden{ display:none !important; }

    /* ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå & ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
    .status-chip{
      padding:8px 14px; border-radius:999px; border:1px solid #e2e8f0; background:#fff;
      font-size:14px; color:#0f172a; transition:.15s; box-shadow:0 1px 0 rgba(2,6,23,.02)
    }
    .status-chip:hover{ background:#f8fafc }
    .status-chip.active{ background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:#fff; border-color:transparent }

    .status-pill{
      padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; display:inline-block;
      background:#e2e8f0; color:#334155;
    }
    .status-pill.waiting{ background:#e0f2fe; color:#075985 } /* ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Admin!N ‡∏ß‡πà‡∏≤‡∏á) */
    .status-pill.submit { background:#dcfce7; color:#166534 }  /* ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/Submit */
    .status-pill.revise { background:#fef9c3; color:#854d0e }  /* ‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/Revise */
    .status-pill.reject { background:#fee2e2; color:#991b1b }  /* ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò/Reject */
    
    /* ===== Modal styles (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î) ===== */
.modal-overlay { background: rgba(0,0,0,.4); }
.modal-card   { border-radius: 18px; box-shadow: 0 20px 60px rgba(2,6,23,.25); overflow: hidden; }
.modal-head   { padding: 18px 22px; font-weight: 800; font-size: 20px; }
.modal-close  { position:absolute; right:16px; top:12px; font-size:22px; color:#94a3b8; }
.modal-close:hover { color:#475569; }

.total-box{
  background:#eaf2ff; border-radius:14px; padding:14px 16px; min-width: 220px;
  text-align:right; box-shadow: inset 0 0 0 1px rgba(37,99,235,.08);
}
.total-box .label{ color:#64748b; font-size:13px; margin-bottom:2px; }
.total-box .value{ color:#1d4ed8; font-weight:800; font-size:28px; line-height:1.1; }

.table-shell{ border:1px solid #e2e8f0; border-radius:14px; overflow:hidden; }
.table-head{ background:#f1f5f9; color:#64748b; font-size:14px; padding:10px 16px; }
.table-row { padding:12px 16px; }
.table-row + .table-row { border-top:1px solid #f1f5f9; }
.col-right{ text-align:right; }
.bold{ font-weight:700; }

  </style>
</head>
<body>

  <!-- ========== VERIFY ========== -->
  <section id="verifyScreen" class="min-h-screen flex items-center justify-center px-4">
    <div class="w-full max-w-3xl text-center">
      <div class="flex items-center justify-center">
        <img class="logo" alt="BJC Big C" src="https://i.postimg.cc/B6wpk3yh/cropped-Logo-BJC-Big-C-2021-2048x606.png">
      </div>

      <h1 class="mt-6 text-3xl md:text-4xl font-extrabold title">APPROVAL STATIONERY STORE</h1>
      <div class="divider"></div>

      <p class="mt-5 text-slate-600">
        üè¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô<br>
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
      </p>

      <div class="mt-7 mx-auto card shadow-soft animate-[fadeIn_.25s_ease-out]">
        <form id="verifyForm" class="text-left">
          <label for="empCode" class="block text-sm text-slate-600">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
          <input id="empCode" name="empCode" type="text" inputmode="numeric" autocomplete="off" required
                 class="mt-2 w-full rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 px-4 py-3 outline-none"
                 placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345">

          <button id="submitBtn" type="submit"
            class="mt-4 w-full btn-primary text-white font-medium rounded-xl py-3 transition-all flex items-center justify-center gap-2 active:translate-y-[1px]">
            <span>üöÄ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</span>
            <svg id="loadingIcon" class="hidden animate-spin" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="white" stroke-width="4"></circle>
              <path class="opacity-75" d="M4 12a8 8 0 018-8" stroke="white" stroke-width="4" stroke-linecap="round"></path>
            </svg>
          </button>

          <p id="hint" class="mt-3 text-sm text-rose-600 hidden hint-error">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
        </form>
      </div>
    </div>
  </section>

  <!-- ========== APPROVAL ========== -->
  <section id="approvalScreen" class="hidden">
    <main class="max-w-6xl mx-auto px-4 py-8">
      <div class="flex items-center justify-center mb-3">
        <img src="https://i.postimg.cc/B6wpk3yh/cropped-Logo-BJC-Big-C-2021-2048x606.png" alt="BJC Big C" class="h-10 md:h-12 object-contain">
      </div>

      <h1 class="text-3xl md:text-4xl font-extrabold text-center">APPROVAL STATIONERY STORE</h1>
      <div class="title-underline mx-auto mt-2 mb-6"></div>

      <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -->
      <section class="info-card">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 rounded-full bg-indigo-100 flex items-center justify-center shrink-0">
            <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor" class="text-indigo-500">
              <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-5.33 0-8 2.67-8 5v1h16v-1c0-2.33-2.67-5-8-5z"/>
            </svg>
          </div>

          <div class="w-full">
            <!-- ‡πÅ‡∏ñ‡∏ß 1 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="field-label">Name</div>
                <div id="apvName" class="field-value">‚Äî</div>
              </div>
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="field-label">Email</div>
                <div id="apvEmail" class="field-value">‚Äî</div>
              </div>
            </div>
            <!-- ‡πÅ‡∏ñ‡∏ß 2 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="field-label">Company</div>
                <div id="apvCompany" class="field-value">‚Äî</div>
              </div>
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="field-label">Division</div>
                <div id="apvDivision" class="field-value">‚Äî</div>
              </div>
              <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                <div class="field-label">Cost Center</div>
                <div id="apvCost" class="field-value">‚Äî</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ + ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå -->
      <section class="mt-6">
        <div class="mb-3">
          <div class="text-xl md:text-2xl font-semibold">Approval Items</div>
          <div class="text-sm text-slate-500 -mt-0.5">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
        </div>

        <!-- ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
        <div class="flex flex-wrap gap-2">
          <button class="status-chip active" data-status="ALL">All items</button>
          <button class="status-chip" data-status="WAITING">Waiting for approval</button>
          <button class="status-chip" data-status="SUBMIT">Submit</button>
          <button class="status-chip" data-status="REVISE">Revise</button>
          <button class="status-chip" data-status="REJECT">Reject</button>
        </div>

        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
        <div class="mt-3 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
          <div class="grid grid-cols-[1.1fr,1.1fr,0.9fr,1.4fr,0.8fr,0.9fr,0.9fr] px-4 py-3 bg-slate-50 text-slate-600 text-sm font-medium">
            <div>Request Number</div>
            <div>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</div>
            <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</div>
            <div>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ä‡∏¥‡πâ‡∏ô)</div>
            <div class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
            <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="text-right">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
          </div>
          <div id="reqList" class="divide-y divide-slate-100 text-[15px]"></div>
        </div>
      </section>
    </main>
  </section>

<!-- ========== MODAL ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠ (‡πÉ‡∏´‡∏°‡πà) ========== -->
<div id="detailOverlay" class="fixed inset-0 hidden items-center justify-center modal-overlay z-[60]">
  <div class="bg-white w-[min(880px,92vw)] relative modal-card">
    <button class="modal-close" onclick="closeDetail()" aria-label="Close">√ó</button>

    <!-- Header -->
    <div class="modal-head">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</div>

    <!-- Body -->
    <div class="px-6 pb-6">
      <!-- ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô: ‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•, ‡∏Ç‡∏ß‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ + Total -->
      <div class="grid grid-cols-1 md:grid-cols-[1fr,320px] gap-4">
        <!-- ‡∏ã‡πâ‡∏≤‡∏¢: 3 ‡∏ö‡∏•‡πá‡∏≠‡∏Å -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <div class="text-slate-500 text-sm">Request Number</div>
            <div id="dReqNo" class="font-semibold">‚Äî</div>
          </div>
          <div>
            <div class="text-slate-500 text-sm">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</div>
            <div id="dRequester" class="font-semibold">‚Äî</div>
          </div>
          <div>
            <div class="text-slate-500 text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</div>
            <div id="dDate" class="font-semibold">‚Äî</div>
          </div>
        </div>

        <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ + Total -->
        <div class="flex md:flex-col gap-3 items-end md:items-stretch">
          <div class="flex items-center gap-2 self-start">
            <span class="text-slate-500 text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
            <span id="dStatusPill" class="status-pill">‚Äî</span>
          </div>
          <div class="total-box w-full">
            <div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</div>
            <div id="dTotal" class="value">0 ‡∏ö‡∏≤‡∏ó</div>
          </div>
        </div>
      </div>

      <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
      <div class="mt-6">
        <div class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</div>
        <div class="table-shell">
          <div class="grid grid-cols-[1.4fr,0.7fr,0.9fr,0.9fr] table-head">
            <div>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            <div class="col-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
            <div class="col-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</div>
            <div class="col-right">‡∏£‡∏ß‡∏°</div>
          </div>
          <div id="dItems"></div>
        </div>
      </div>

      <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô -->
      <div class="mt-5">
        <label class="text-sm text-slate-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (Comment)</label>
        <textarea id="dComment" rows="3"
          class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 outline-none focus:ring-4 focus:ring-blue-100"></textarea>
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏° -->
      <div class="mt-6 flex flex-wrap gap-2 justify-end">
        <button class="px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300" onclick="closeDetail()">‡∏õ‡∏¥‡∏î</button>
        <button class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:brightness-105" onclick="actOnCurrent('SUBMIT')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
        <button class="px-4 py-2 rounded-xl bg-rose-600 text-white hover:brightness-105" onclick="actOnCurrent('REJECT')">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
        <button class="px-4 py-2 rounded-xl bg-amber-500 text-white hover:brightness-105" onclick="actOnCurrent('REVISE')">üìù ‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </div>
    </div>
  </div>
</div>

  <script>
/* ===== CONFIG ===== */
const SHEET_ID    = '15Nzap1xe_qkcBoVskRTMG7o7Gb_zE8nTRm8rY3VeMmg';
const SHEET_USER  = 'User Approve';
const SHEET_RESP  = 'Response';
const SHEET_ADMIN = 'Admin';  // A=Request Number, N=Status

// ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Apps Script endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå ‡πÉ‡∏™‡πà URL ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
const API_BASE    = 'https://script.google.com/macros/s/AKfycbyUDaiiIRN2_OfWgqiusRYivGmed5Gj0K8_Ry5ogXlNRx854YHvsWizjr83jHQkxcO4Cw/exec';

/* ===== Helpers ===== */
function showPage(which){
  const verify = document.getElementById('verifyScreen');
  const appr   = document.getElementById('approvalScreen');
  if(which === 'approval'){ verify.classList.add('hidden'); appr.classList.remove('hidden'); window.scrollTo(0,0); }
  else { appr.classList.add('hidden'); verify.classList.remove('hidden'); }
}
function setLoading(on){
  const btn = document.getElementById('submitBtn');
  const icon = document.getElementById('loadingIcon');
  btn.disabled = on; icon.classList.toggle('hidden', !on); btn.style.opacity = on ? .85 : 1;
}
function showHint(msg){ const el = document.getElementById('hint'); el.textContent = msg || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'; el.classList.remove('hidden'); }
function hideHint(){ document.getElementById('hint').classList.add('hidden'); }

function gvizUrl(sheetName, tq){
  const qs = new URLSearchParams({ tqx:'out:json', sheet: sheetName, tq });
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?` + qs.toString();
}
async function fetchGVizRows(url){
  const res = await fetch(url, { cache:'no-store' });
  const txt = await res.text();
  const m = txt.match(/setResponse\(([\s\S]*)\);?$/);
  if(!m) throw new Error('Bad GViz');
  const json = JSON.parse(m[1]);
  const cols = json.table.cols.map(c=>c.label || c.id || '');
  const rows = json.table.rows.map(r => {
    const obj = {};
    r.c.forEach((c,i)=> obj[cols[i] || `c${i}`] = c ? c.v : null );
    obj._arr = r.c.map(c => c ? c.v : null); // raw array
    return obj;
  });
  return rows;
}

/* ===== Approver Header ===== */
function fillApprover(ap){
  document.getElementById('apvName').textContent     = ap.name || '‚Äî';
  document.getElementById('apvEmail').textContent    = ap.email || '‚Äî';
  document.getElementById('apvCompany').textContent  = ap.company || '‚Äî';
  document.getElementById('apvDivision').textContent = ap.division || '‚Äî';
  document.getElementById('apvCost').textContent     = ap.costCenter || '‚Äî';
}

/* ===== VERIFY ===== */
document.getElementById('verifyForm').addEventListener('submit', async (e)=>{
  e.preventDefault(); hideHint();
  const code = document.getElementById('empCode').value.trim();
  if(!code){ showHint('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return; }

  setLoading(true);
  try{
    // A-F ‡∏à‡∏≤‡∏Å User Approve
    const tqU = `select A,B,C,D,E,F where A='${code.replace(/'/g,"\\'")}'`;
    const [rec] = await fetchGVizRows(gvizUrl(SHEET_USER, tqU));
    if(!rec){ showHint('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'); return; }

    const approver = {
      empCode:    rec._arr?.[0] ?? code,
      name:       rec._arr?.[1] ?? '',
      email:      rec._arr?.[2] ?? '',
      company:    rec._arr?.[3] ?? '',
      division:   rec._arr?.[4] ?? '',
      costCenter: rec._arr?.[5] ?? '',
      verifiedAt: new Date().toISOString()
    };
    sessionStorage.setItem('approver', JSON.stringify(approver));

    fillApprover(approver);
    showPage('approval');
    await loadAndRenderList('ALL');
  }catch(err){
    console.error(err);
    showHint('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
  }finally{ setLoading(false); }
});

/* ===== LIST + FILTERS ===== */
let RESP_ROWS = [];
let CURRENT_FILTER = 'ALL';
let CURRENT_DETAIL = null;
let ADMIN_STATUS_MAP = null; // Map<RequestNo, displayStatus)

// ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‚Üí ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏á
function normalizeStatus(txt){
  const s = String(txt || '').trim();
  if (!s) return 'SUBMIT'; // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‚Üí ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° SUBMIT
  const u = s.toUpperCase();
  if (u.includes('APPROVE') || u.includes('SUBMIT') || s.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') || s.includes('‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')) return 'SUBMIT';
  if (u.includes('REVISE')  || s.includes('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç')) return 'REVISE';
  if (u.includes('REJECT')  || s.includes('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò')) return 'REJECT';
  return 'SUBMIT';
}
function statusClass(norm){
  const t = (norm||'').toUpperCase();
  if (t==='SUBMIT') return 'submit';
  if (t==='REVISE') return 'revise';
  if (t==='REJECT') return 'reject';
  return '';
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Admin: select A,N ‚Üí A=RequestNo, N=Status
async function loadAdminStatus(){
  if (ADMIN_STATUS_MAP) return ADMIN_STATUS_MAP;
  const tq = 'select A, N';
  const rows = await fetchGVizRows(gvizUrl(SHEET_ADMIN, tq));
  const map = new Map();
  for (const r of rows){
    const arr = r._arr || [];
    const reqNo  = arr[0] ?? '';   // A
    const status = arr[13] ?? '';  // N (A=0..N=13)
    if (!reqNo) continue;
    const display = String(status || '').trim() || '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
    map.set(reqNo, display);
  }
  ADMIN_STATUS_MAP = map;
  return map;
}

async function loadAndRenderList(filter){
  CURRENT_FILTER = filter || CURRENT_FILTER;

  if (RESP_ROWS.length === 0) {
    const tqR = 'select *';
    RESP_ROWS = await fetchGVizRows(gvizUrl(SHEET_RESP, tqR));
  }
  const adminMap = await loadAdminStatus();

  // index ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô Response
  const idxA = 0;   // Request number
  const idxB = 1;   // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠
  const idxG = 6;   // ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å
  const idxJ = 9;   // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£(‡∏ä‡∏¥‡πâ‡∏ô)
  const idxK = 10;  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô

  // ‡∏Å‡∏£‡∏≠‡∏á
  let rows = RESP_ROWS.slice();
  if (CURRENT_FILTER !== 'ALL') {
    rows = rows.filter(r => {
      const arr = r._arr || [];
      const reqNo = arr[idxA] ?? '';
      const raw = String(adminMap.get(reqNo) || '').trim();

      if (CURRENT_FILTER === 'WAITING') {
        return raw === ''; // Admin!N ‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÜ
      }

      const disp = raw || '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
      const norm = normalizeStatus(disp);
      return norm === CURRENT_FILTER;
    });
  }

  // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå
  const host = document.getElementById('reqList');
  host.innerHTML = rows.map((r, i) => {
    const arr = r._arr || [];
    const reqNo   = arr[idxA] ?? '‚Äî';
    const reqDate = arr[idxB] ?? '‚Äî';
    const reqBy   = arr[idxG] ?? '‚Äî';
    const items   = arr[idxJ] ?? '‚Äî';
    const total   = arr[idxK] ?? 0;

    const rawStatus     = String(adminMap.get(reqNo) || '').trim();
    const displayStatus = rawStatus || '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
    const pillClass     = rawStatus === '' ? 'waiting' : statusClass(normalizeStatus(displayStatus));

    return `
    <div class="grid grid-cols-[1.1fr,1.1fr,0.9fr,1.4fr,0.8fr,0.9fr,0.9fr] px-4 py-3 items-center">
      <div class="text-blue-700 font-semibold whitespace-nowrap">${reqNo}</div>
      <div class="truncate">${reqBy || '‚Äî'}</div>
      <div>${reqDate || '‚Äî'}</div>
      <div class="truncate">${items || '‚Äî'}</div>
      <div class="text-right font-semibold">${Number(total||0).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
      <div><span class="status-pill ${pillClass}">${displayStatus}</span></div>
      <div class="text-right">
        <button class="px-3 py-1.5 rounded-xl bg-blue-600 text-white hover:brightness-105"
                onclick='openDetail(${JSON.stringify({i}).replace(/"/g,"&quot;")})'>
          ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        </button>
      </div>
    </div>`;
  }).join('');
}

/* ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡∏•‡∏¥‡∏Å */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.status-chip');
  if(!btn) return;
  document.querySelectorAll('.status-chip').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  loadAndRenderList(btn.dataset.status);
});

/* ===== DETAIL MODAL ===== */
function parseLineItems(arr){
  const out = [];
  for (let i = 11; i < arr.length; i += 3) { // ‡πÄ‡∏£‡∏¥‡πà‡∏° L (index 11) ‚Üí ‡∏ä‡∏∏‡∏î‡∏•‡∏∞ 3 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    const name  = arr[i];
    const qty   = arr[i+1];
    const price = arr[i+2];
    if (!name && !qty && !price) continue;
    const q = Number(qty || 0);
    const p = Number(price || 0);
    out.push({ name: name || '-', qty: q, price: p, sum: q * p });
  }
  return out;
}

async function openDetail({i}){
  const r = RESP_ROWS[i];
  if(!r) return;
  CURRENT_DETAIL = i;
  const arr = r._arr || [];
  const idxA=0, idxB=1, idxG=6, idxK=10;

  const reqNo   = arr[idxA] ?? '‚Äî';
  const reqDate = arr[idxB] ?? '‚Äî';
  const reqBy   = arr[idxG] ?? '‚Äî';
  const total   = Number(arr[idxK] ?? 0);

  // ‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  document.getElementById('dReqNo').textContent     = reqNo;
  document.getElementById('dRequester').textContent = reqBy;
  document.getElementById('dDate').textContent      = reqDate;
  document.getElementById('dTotal').textContent     = `${total.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

  // ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Admin!N (‡∏ß‡πà‡∏≤‡∏á = ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)
  const adminMap       = await loadAdminStatus();
  const rawStatus      = String(adminMap.get(reqNo) || '').trim();
  const displayStatus  = rawStatus || '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
  const pillClass      = rawStatus === '' ? 'waiting' : statusClass(normalizeStatus(displayStatus));
  const pill           = document.getElementById('dStatusPill');
  pill.textContent     = displayStatus;
  pill.className       = `status-pill ${pillClass}`;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ L‚Üí ... (‡∏ä‡∏∏‡∏î‡∏•‡∏∞ 3 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ‡∏ä‡∏∑‡πà‡∏≠/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏£‡∏≤‡∏Ñ‡∏≤)
  const host  = document.getElementById('dItems');
  const lines = parseLineItems(arr); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
  host.innerHTML = lines.length
    ? lines.map(li => `
        <div class="grid grid-cols-[1.4fr,0.7fr,0.9fr,0.9fr] table-row items-center">
          <div>${li.name || '-'}</div>
          <div class="col-right">${(li.qty ?? 0).toLocaleString()}</div>
          <div class="col-right">${(li.price ?? 0).toLocaleString()}</div>
          <div class="col-right bold">${(li.sum ?? 0).toLocaleString()}</div>
        </div>
      `).join('')
    : `<div class="table-row text-slate-500 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢</div>`;

  // ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏°‡∏î‡∏≠‡∏•
  const ov = document.getElementById('detailOverlay');
  ov.classList.remove('hidden'); ov.classList.add('flex');
}
    
    
function closeDetail(){
  const ov = document.getElementById('detailOverlay');
  ov.classList.add('hidden'); ov.classList.remove('flex');
}

/* ===== ACTIONS (Submit/Revise/Reject) ===== */
async function actOnCurrent(type){
  const idx = CURRENT_DETAIL;
  if(idx == null) return;
  const r = RESP_ROWS[idx];
  const reqNo = r?._arr?.[0] || '‚Äî';
  const comment = document.getElementById('dComment').value || '';
  const ap = JSON.parse(sessionStorage.getItem('approver') || '{}');

  try{
    const res = await fetch(API_BASE, {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({
        action: 'act',
        type,               // 'SUBMIT' | 'REVISE' | 'REJECT'
        requestNo: reqNo,
        approver: ap?.name || '',
        approverEmail: ap?.email || '',
        comment
      })
    });
    const data = await res.json().catch(()=>({ok:false}));
    if(!data.ok){ alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (data.error || 'Unknown')); return; }
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');

    closeDetail();
    // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Admin
    RESP_ROWS = [];
    ADMIN_STATUS_MAP = null;
    await loadAndRenderList(CURRENT_FILTER);
  }catch(err){
    console.error(err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
  }
}
    
    // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
document.getElementById('detailOverlay').addEventListener('click', (e)=>{
  if (e.target.id === 'detailOverlay') closeDetail();
});

// ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ ESC
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape') closeDetail();
});


/* ===== Boot: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ session ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤ Approval ‡πÄ‡∏•‡∏¢ ===== */
(async function boot(){
  const raw = sessionStorage.getItem('approver');
  if(raw){
    try{
      const ap = JSON.parse(raw);
      if(ap?.name || ap?.email){
        fillApprover(ap);
        showPage('approval');
        await loadAndRenderList('ALL');
        return;
      }
    }catch{}
  }
  // ‡πÑ‡∏°‡πà‡∏û‡∏ö session ‚Üí ‡∏´‡∏ô‡πâ‡∏≤ verify
})();
  </script>
</body>
</html>
